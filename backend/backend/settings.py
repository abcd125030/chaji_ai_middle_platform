"""
Django settings for backend project.

Generated by 'django-admin startproject' using Django 5.1.5.
"""

from pathlib import Path
from datetime import timedelta
import os
from dotenv import load_dotenv
from urllib.parse import urlparse, quote

# æ£€æŸ¥ torch æ˜¯å¦å¯ç”¨
try:
    import torch
    GPU_AVAILABLE = torch.cuda.is_available()
except ImportError:
    GPU_AVAILABLE = False

# Build paths
BASE_DIR = Path(__file__).resolve().parent.parent

# Load environment variables
load_dotenv()

# æµ‹è¯•ç¯å¢ƒæ§åˆ¶
IS_TEST_ENV = os.getenv('IS_TEST_ENV', 'False').lower() == 'true'

# å®‰å…¨é…ç½® (ä».envåŠ è½½)
SECRET_KEY = os.getenv("DJANGO_SECRET_KEY", "django-insecure-default-key")
DEBUG = os.getenv("DJANGO_DEBUG", "False").lower() == "true"

# ç”Ÿäº§ç¯å¢ƒåŸŸåé…ç½® (ä».envåŠ è½½)
# æ ¼å¼è¯´æ˜:
# ALLOWED_HOSTS - å…è®¸è®¿é—®çš„åŸŸå/IPåˆ—è¡¨(é€—å·åˆ†éš”)ï¼Œç”¨äºé˜²æ­¢HTTP Hostå¤´æ”»å‡»
# CSRF_TRUSTED_ORIGINS - ä¿¡ä»»çš„æºç«™URLåˆ—è¡¨(åŒ…å«åè®®)ï¼Œç”¨äºCSRFä¿æŠ¤
# CORS_ALLOWED_ORIGINS - å…è®¸è·¨åŸŸè®¿é—®çš„å‰ç«¯URLåˆ—è¡¨ï¼Œç”¨äºCORSæ§åˆ¶
#
# ä¸‰è€…åŒºåˆ«:
# 1. ALLOWED_HOSTS: æœåŠ¡ç«¯å®‰å…¨éªŒè¯
# 2. CSRF_TRUSTED_ORIGINS: è¡¨å•æäº¤å®‰å…¨éªŒè¯
# 3. CORS_ALLOWED_ORIGINS: å‰ç«¯APIè°ƒç”¨æƒé™æ§åˆ¶
ALLOWED_HOSTS = os.getenv("DJANGO_ALLOWED_HOSTS", "localhost,127.0.0.1").split(",")
CSRF_TRUSTED_ORIGINS = (
    os.getenv("DJANGO_CSRF_TRUSTED_ORIGINS", "").split(",")
    if os.getenv("DJANGO_CSRF_TRUSTED_ORIGINS")
    else []
)

# Web API å›è°ƒé…ç½®
WEB_API_BASE_URL = os.environ.get('WEB_API_BASE_URL', 'http://localhost:3000/_studio/api')
INTERNAL_API_TOKEN = os.environ.get('INTERNAL_API_TOKEN', 'default-internal-token-change-in-production')

CORS_ALLOWED_ORIGINS = (
    os.getenv("CORS_ALLOWED_ORIGINS", "").split(",")
    if os.getenv("CORS_ALLOWED_ORIGINS")
    else []
)

CORS_ALLOW_CREDENTIALS = True
CORS_ALLOW_ALL_ORIGINS = False

parsed_server_host = urlparse(os.getenv("SERVER_HOST", "http://localhost:8000"))

# ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„FORCE_SCRIPT_NAMEï¼Œå¦‚æœæ²¡æœ‰åˆ™ä»SERVER_HOSTè§£æ
if os.getenv("FORCE_SCRIPT_NAME"):
    FORCE_SCRIPT_NAME = os.getenv("FORCE_SCRIPT_NAME")
else:
    FORCE_SCRIPT_NAME = parsed_server_host.path if parsed_server_host.path else None

# ç”Ÿäº§ç¯å¢ƒé»˜è®¤é…ç½®
if not DEBUG:
    SECURE_PROXY_SSL_HEADER = ("HTTP_X_FORWARDED_PROTO", "https")
    USE_X_FORWARDED_HOST = True
    USE_X_FORWARDED_PORT = True
    SESSION_COOKIE_SECURE = True
    CSRF_COOKIE_SECURE = True
    # å…³é—­SECURE_SSL_REDIRECTï¼Œå› ä¸ºæˆ‘ä»¬é€šè¿‡nginxåå‘ä»£ç†å¤„ç†SSL
    # è¿™æ ·å¯ä»¥é¿å…å¾ªç¯é‡å®šå‘é—®é¢˜
    SECURE_SSL_REDIRECT = False

# Jazzmin é…ç½® - ç¾åŒ– Django Admin ç•Œé¢
JAZZMIN_SETTINGS = {
    # æ ‡é¢˜å’Œå“ç‰Œ
    "site_title": "AIä¸­å°ç®¡ç†ç³»ç»Ÿ",
    "site_header": "AIä¸­å°",
    "site_brand": "AI Platform",
    "site_logo": None,  # å¯ä»¥è®¾ç½®ä¸º "images/logo.png"
    "site_logo_classes": "img-circle",
    "site_icon": None,  # å¯ä»¥è®¾ç½®ä¸º "fas fa-brain"
    
    # æ¬¢è¿ä¿¡æ¯
    "welcome_sign": "æ¬¢è¿è®¿é—® AI ä¸­å°ç®¡ç†ç³»ç»Ÿ",
    "copyright": "AI Platform Â© 2025",
    
    # æœç´¢æ¨¡å‹
    "search_model": ["authentication.User", "llm.LLMCallLog"],
    
    # å­—æ®µå›¾æ ‡
    "icons": {
        "auth": "fas fa-users-cog",
        "authentication.User": "fas fa-user",
        "auth.Group": "fas fa-users",
        
        # LLM åº”ç”¨
        "llm.LLMCallLog": "fas fa-history",
        "llm.LLMTokenUsage": "fas fa-chart-line",
        "llm.LLMModelPrice": "fas fa-dollar-sign",
        "llm.LLMRequestCache": "fas fa-database",
        
        # Router åº”ç”¨
        "router.LLMModel": "fas fa-robot",
        "router.VendorEndpoint": "fas fa-server",
        "router.VendorAPIKey": "fas fa-key",
        
        # Chat åº”ç”¨
        
        # Knowledge åº”ç”¨
        "knowledge.KnowledgeCollection": "fas fa-book",
        "knowledge.Document": "fas fa-file-alt",
        
        # Agentic åº”ç”¨
        "agentic.Graph": "fas fa-project-diagram",
        "agentic.Node": "fas fa-circle-nodes",
        "agentic.Task": "fas fa-tasks",
        
        # Webapps
        "webapps.pagtive.Project": "fas fa-folder-open",
        "webapps.payment.Order": "fas fa-shopping-cart",
        "webapps.chat.ChatMessage": "fas fa-message",
        
        # Customized
        "customized.customization.CustomizationTask": "fas fa-cog",
        "customized.pdf_converter.PDFConversionTask": "fas fa-file-pdf",
    },
    
    # é»˜è®¤å›¾æ ‡
    "default_icon_parents": "fas fa-chevron-circle-right",
    "default_icon_children": "fas fa-circle",
    
    # è‡ªå®šä¹‰ CSS/JS
    "custom_css": "admin/css/nextjs-theme.css",
    "custom_js": None,
    "use_google_fonts_cdn": False,  # ä½¿ç”¨æœ¬åœ°å­—ä½“ï¼Œé¿å…è®¿é—® Google
    "show_ui_builder": False,
    
    # ç”¨æˆ·èœå•é¡¹
    "usermenu_links": [
        {"name": "æ–‡æ¡£", "url": "/api/docs/", "new_window": True},
        {"model": "authentication.user"},
        {"name": "æ”¯æŒ", "url": "https://github.com/your-org/your-repo/issues", "new_window": True},
    ],
    
    # é¡¶éƒ¨èœå•
    "topmenu_links": [
        {"name": "é¦–é¡µ", "url": "admin:index", "permissions": ["auth.view_user"]},
        {"name": "API æ–‡æ¡£", "url": "/api/docs/", "new_window": True},
        {"model": "authentication.User"},
        {"app": "llm"},
    ],
    
    # ä¾§è¾¹æ 
    "show_sidebar": True,
    "navigation_expanded": False,  # é»˜è®¤æŠ˜å å·¦ä¾§èœå•
    "hide_apps": [],
    "hide_models": [],
    "order_with_respect_to": [
        # ä¸šåŠ¡æ ¸å¿ƒæ¨¡å— - æœ€é«˜ä¼˜å…ˆçº§
        "agentic",              # Agenticå·¥ä½œæµ
        "agentic_graph",        # Agentic Graphå¼•æ“
        "knowledge",            # çŸ¥è¯†åº“

        # ä¸šåŠ¡åŠŸèƒ½æ¨¡å—
        "webapps.chat",         # Chatåº”ç”¨
        "webapps.payment",      # æ”¯ä»˜ç®¡ç†
        "webapps.pagtive",      # Pagtiveåº”ç”¨
        "customized.customization",  # å®šåˆ¶åŠŸèƒ½
        "customized.image_editor",   # å›¾ç‰‡ç¼–è¾‘å™¨

        # åŸºç¡€æœåŠ¡æ¨¡å—
        "llm",                  # LLMé…ç½®
        "router",               # è·¯ç”±é…ç½®
        "tools",                # å·¥å…·ç®¡ç†
        "mineru",              # PDFå¤„ç†

        # ç³»ç»Ÿç®¡ç†æ¨¡å—
        "authentication",       # ç”¨æˆ·è®¤è¯
        "access_control",      # è®¿é—®æ§åˆ¶
        "service_api",         # æœåŠ¡API

        # Djangoé»˜è®¤æ¨¡å—
        "auth",                # Djangoè®¤è¯
    ],
    
    # è‡ªå®šä¹‰åº”ç”¨æ’åºå’Œå¿«é€Ÿé“¾æ¥
    "custom_links": {
        "agentic": [{
            "name": "ğŸš€ åˆ›å»ºæ–°å·¥ä½œæµ",
            "url": "admin:agentic_graph_add",
            "icon": "fas fa-plus-circle",
            "permissions": ["agentic.add_graph"]
        }],
        "agentic_graph": [{
            "name": "ğŸ“Š ä»»åŠ¡æ‰§è¡Œç›‘æ§",
            "url": "admin:agentic_graph_taskexecution_changelist",
            "icon": "fas fa-tasks",
            "permissions": ["agentic_graph.view_taskexecution"]
        }],
        "llm": [{
            "name": "ğŸ“ˆ LLMä½¿ç”¨ç»Ÿè®¡",
            "url": "admin:llm_llmtokenusage_changelist",
            "icon": "fas fa-chart-bar",
            "permissions": ["llm.view_llmtokenusage"]
        }],
        "knowledge": [{
            "name": "ğŸ“š çŸ¥è¯†åº“æ€»è§ˆ",
            "url": "admin:knowledge_knowledgecollection_changelist",
            "icon": "fas fa-database",
            "permissions": ["knowledge.view_knowledgecollection"]
        }],
    },
    
    # UI è°ƒæ•´
    "changeform_format": "horizontal_tabs",  # è¡¨å•å¸ƒå±€: horizontal_tabs, vertical_tabs, carousel, single
    "changeform_format_overrides": {
        "auth.user": "carousel",
        "auth.group": "vertical_tabs",
    },
    
    # ä¸»é¢˜è®¾ç½®
    "theme": "default",  # ä½¿ç”¨é»˜è®¤ä¸»é¢˜ä½œä¸ºåŸºç¡€ï¼Œé€šè¿‡è‡ªå®šä¹‰CSSè¦†ç›–
    "dark_mode_theme": None,  # ä¸éœ€è¦å•ç‹¬çš„æš—è‰²æ¨¡å¼
    "button_classes": {
        "primary": "btn-primary",
        "secondary": "btn-secondary",
        "info": "btn-info",
        "warning": "btn-warning",
        "danger": "btn-danger",
        "success": "btn-success"
    },
    
    # ç›¸å…³æ¨¡å‹å±•ç¤º
    "related_modal_active": True,
    "show_changeform_submit": True,
    
    # è¯­è¨€ä»£ç 
    "language_chooser": False,
}

# UI ä¸»é¢˜é…ç½® - Next.jsé£æ ¼çº¯é»‘é“¶ç™½é…è‰²
JAZZMIN_UI_TWEAKS = {
    "navbar_small_text": False,
    "footer_small_text": False,
    "body_small_text": True,  # å¯ç”¨æ›´å°çš„æ­£æ–‡å­—ä½“
    "brand_small_text": False,
    "brand_colour": None,  # ä¸ä½¿ç”¨é¢„è®¾é¢œè‰²ï¼Œç”±è‡ªå®šä¹‰CSSæ§åˆ¶
    "accent": None,  # ä¸ä½¿ç”¨é¢„è®¾å¼ºè°ƒè‰²
    "navbar": "navbar-dark",  # åŸºç¡€æ·±è‰²å¯¼èˆªæ 
    "no_navbar_border": True,  # å»æ‰è¾¹æ¡†è®©ç•Œé¢æ›´ç®€æ´
    "navbar_fixed": True,
    "layout_boxed": False,
    "footer_fixed": False,
    "sidebar_fixed": True,
    "sidebar": "sidebar-dark-primary",  # æ·±è‰²ä¾§è¾¹æ 
    "sidebar_nav_small_text": True,  # ä¾§è¾¹æ ä½¿ç”¨å°å­—ä½“
    "sidebar_disable_expand": False,
    "sidebar_nav_child_indent": True,  # å­èœå•ç¼©è¿›
    "sidebar_nav_compact_style": False,
    "sidebar_nav_legacy_style": False,
    "sidebar_nav_flat_style": True,
    "theme": "default",  # ä½¿ç”¨é»˜è®¤ä¸»é¢˜ä½œä¸ºåŸºç¡€
    "dark_mode_theme": None,
    "button_classes": {
        "primary": "btn-primary",
        "secondary": "btn-secondary",
        "info": "btn-info",
        "warning": "btn-warning",
        "danger": "btn-danger",
        "success": "btn-success"
    },
    "actions_sticky_top": True,
}

# Application definition
INSTALLED_APPS = [
    "corsheaders",
    "jazzmin",
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    "rest_framework",
    "rest_framework_simplejwt",
    "django_redis",  # Redis ç¼“å­˜åç«¯
    "django_rename_app",
    "authentication",
    "service_api",
    "router",
    "llm",  # llm è°ƒç”¨æ–¹æ³•
    "access_control",
    "customized.customization",
    # "customized.delivery_performance",  # åº”ç”¨å·²ç§»é™¤
    # "customized.pdf_converter",  # åº”ç”¨å·²ç§»é™¤
    "customized.image_editor",
    "knowledge",
    "webapps",  # Webåº”ç”¨é›†åˆ
    "webapps.chat",  # Chatå­åº”ç”¨
    "webapps.pagtive",  # Pagtiveå­åº”ç”¨
    "webapps.payment",  # Paymentæ”¯ä»˜å­åº”ç”¨
    "webapps.toolkit",  # å·¥å…·é›†åº”ç”¨
    "webapps.moments",  # å…¬å¸åœˆäº‹ä»¶å¤„ç†
    "webapps.xiaohongshu",  # å°çº¢ä¹¦èˆ†æƒ…ç›‘æ§
    "webapps.market",  # frago Cloud å¸‚åœº - Recipe å¸‚åœºä¸ä¼šè¯åŒæ­¥
    "agentic",  # ç”¨äºæ„å»ºå’Œç®¡ç†æœ‰çŠ¶æ€ã€å¤šè§’è‰²çš„ä»£ç†ï¼ˆAgentï¼‰åº”ç”¨
    "agentic_graph",  # æ–°çš„ Graph å¤„ç†å¼•æ“ï¼Œä¸åŸ agentic åº”ç”¨éš”ç¦»
    "tools",  # ç”¨äºç»Ÿä¸€ç®¡ç†å’Œæ‰¿è½½ Agent å·¥å…·é›†
    # "django_celery_results", # Celery ç»“æœåç«¯ï¼Œä¸å†ä½¿ç”¨ï¼Œæ”¹ç”¨Redis DB 2äº†
    "mineru",  # MinerU PDF è§£ææœåŠ¡
    "dataset_downloader",  # æ•°æ®é›†ä¸‹è½½ä»»åŠ¡ç®¡ç†
    "test_app",  # æµ‹è¯•åº”ç”¨
]

MIDDLEWARE = [
    "django.middleware.security.SecurityMiddleware",
    "whitenoise.middleware.WhiteNoiseMiddleware",  # æ·»åŠ  WhiteNoise ä¸­é—´ä»¶
    "django.contrib.sessions.middleware.SessionMiddleware",
    "corsheaders.middleware.CorsMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "authentication.middleware.EnsureUserProfileMiddleware",  # ç¡®ä¿ç”¨æˆ·æœ‰UserProfile
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
]

# å…è®¸åŒæº iframeï¼ˆDjango Admin popup çª—å£éœ€è¦ï¼‰
X_FRAME_OPTIONS = "SAMEORIGIN"

ROOT_URLCONF = "backend.urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [
            os.path.join(BASE_DIR, "templates"),  # æ·»åŠ å…¨å±€templatesç›®å½•
            os.path.join(BASE_DIR, "login/templates")
        ],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ]
        },
    }
]

WSGI_APPLICATION = "backend.wsgi.application"

# Database

# æ•°æ®åº“é…ç½®
# æ ¹æ®ç«¯å£åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ PgBouncer
DB_PORT = os.getenv("DB_PORT", "6432")
IS_PGBOUNCER = DB_PORT == "6432"  # 6432 æ˜¯ PgBouncer é»˜è®¤ç«¯å£

DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.postgresql",  # ä½¿ç”¨åŸç”Ÿåç«¯
        "NAME": os.getenv("DB_DATABASE", "X"),
        "USER": os.getenv("DB_USER", "postgres"),
        "PASSWORD": os.getenv("DB_PASSWORD", ""),
        "HOST": os.getenv("DB_HOST", "localhost"),
        "PORT": DB_PORT,
        # PgBouncer ç¯å¢ƒå¿…é¡»ä¸º 0ï¼Œç›´è¿ç¯å¢ƒå¯ä»¥ä½¿ç”¨è¿æ¥æ± 
        "CONN_MAX_AGE": 0 if IS_PGBOUNCER else 600,  # ç›´è¿æ—¶ä½¿ç”¨ 10 åˆ†é’Ÿè¿æ¥æ± 
        "CONN_HEALTH_CHECKS": not IS_PGBOUNCER,  # ç›´è¿æ—¶å¯ç”¨å¥åº·æ£€æŸ¥
        "OPTIONS": {
            "connect_timeout": 5,
        }
    }
}

# ç›´è¿ PostgreSQL æ—¶æ·»åŠ  keepalive å‚æ•°
if not IS_PGBOUNCER:
    DATABASES["default"]["OPTIONS"].update({
        "keepalives": 1,
        "keepalives_idle": 30,
        "keepalives_interval": 10,
        "keepalives_count": 5,
    })

# ä¸å†éœ€è¦æ¡ä»¶åˆ¤æ–­å’Œé…ç½®è¦†ç›–
# ä¸è¦è°ƒç”¨ get_database_configï¼Œå®ƒä¼šæ·»åŠ ä¸å…¼å®¹çš„å‚æ•°
# DATABASES['default'] = get_database_config(DATABASES['default'])  # ç¦ç”¨

# Redis Configuration
# ------------------------------------------------------------------------------
# ç»Ÿä¸€é…ç½® Redis è¿æ¥ä¿¡æ¯ï¼Œä¾› Django Cache å’Œ Celery ä½¿ç”¨
REDIS_HOST = os.getenv("REDIS_HOST", "localhost")
REDIS_PORT = os.getenv("REDIS_PORT", "6379")
REDIS_PASSWORD = os.getenv("REDIS_PASSWORD", None)
REDIS_PASSWORD_QUOTED = quote(REDIS_PASSWORD) if REDIS_PASSWORD else None

# Cache Configuration
# ------------------------------------------------------------------------------
CACHE_DB = os.getenv("CACHE_DB", "1")
CACHE_LOCATION = f"redis://{REDIS_HOST}:{REDIS_PORT}/{CACHE_DB}"
if REDIS_PASSWORD:
    # ä½¿ç”¨ URL ç¼–ç åçš„å¯†ç æ„å»ºè¿æ¥å­—ç¬¦ä¸²ï¼Œä»¥å¤„ç†ç‰¹æ®Šå­—ç¬¦
    CACHE_LOCATION = f"redis://:{REDIS_PASSWORD_QUOTED}@{REDIS_HOST}:{REDIS_PORT}/{CACHE_DB}"

CACHE_MIDDLEWARE_SECONDS = int(
    os.getenv("CACHE_MIDDLEWARE_SECONDS", "900")
)  # é»˜è®¤15åˆ†é’Ÿ
CACHES = {
    "default": {
        "BACKEND": "django_redis.cache.RedisCache",
        "LOCATION": os.getenv("REDIS_LOCATION", CACHE_LOCATION),
        "OPTIONS": {
            "CLIENT_CLASS": "django_redis.client.DefaultClient",
            "CONNECTION_POOL_KWARGS": {"max_connections": 500},  # å¢åŠ è¿æ¥æ± ä»¥æ”¯æŒé«˜å¹¶å‘
            # å¯†ç å·²åœ¨ LOCATION URL ä¸­æä¾›ï¼Œæ­¤å¤„æ— éœ€é‡å¤è®¾ç½®
            # "PASSWORD": REDIS_PASSWORD if REDIS_PASSWORD else "",
        },
        "KEY_PREFIX": "X",
    }
}

# Password validation
AUTH_PASSWORD_VALIDATORS = [
    {
        "NAME": "django.contrib.auth.password_validation.UserAttributeSimilarityValidator"
    },
    {"NAME": "django.contrib.auth.password_validation.MinimumLengthValidator"},
    {"NAME": "django.contrib.auth.password_validation.CommonPasswordValidator"},
    {"NAME": "django.contrib.auth.password_validation.NumericPasswordValidator"},
]

# Internationalization
LANGUAGE_CODE = "zh-hans"
TIME_ZONE = "Asia/Shanghai"
USE_I18N = True
USE_TZ = True

# Static files
STATIC_URL = "/static/"
STATIC_ROOT = os.path.join(BASE_DIR, "staticfiles")
STATICFILES_DIRS = [
    os.path.join(BASE_DIR, "static"),
    os.path.join(BASE_DIR, "access_control/static"),
]

# Media files (for user uploads)
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# OSS é…ç½® - ç”¨äºç”Ÿäº§ç¯å¢ƒç›´é“¾è®¿é—®
# å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨æœ¬åœ° /media/ è·¯å¾„
# ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ OSS å…¬å¼€åŸŸåç›´é“¾ï¼ˆé¿å…æµé‡ç»è¿‡æœåŠ¡å™¨ï¼‰
OSS_PUBLIC_DOMAIN = os.getenv('OSS_PUBLIC_DOMAIN', '')

# å¼€å‘ç¯å¢ƒåç«¯ URLï¼ˆç”¨äºå‰ç«¯è·¨åŸŸè®¿é—®å›¾ç‰‡ï¼‰
# å¼€å‘ç¯å¢ƒï¼šå‰ç«¯åœ¨ 3000 ç«¯å£ï¼Œåç«¯åœ¨ 6066 ç«¯å£ï¼Œéœ€è¦å®Œæ•´URLæ‰èƒ½è®¿é—®å›¾ç‰‡
# ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ OSS ç›´é“¾ï¼Œä¸éœ€è¦æ­¤é…ç½®
DEV_BACKEND_URL = 'http://127.0.0.1:6066'

# Media URL å‰ç¼€ï¼ˆæ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©ï¼‰
# DEBUG=True: å¼€å‘ç¯å¢ƒåç«¯å®Œæ•´ URL http://127.0.0.1:6066/media/
# DEBUG=False ä¸”é…ç½®äº† OSS: OSS ç›´é“¾
MEDIA_URL_PREFIX = f'{DEV_BACKEND_URL}/media/' if DEBUG else (OSS_PUBLIC_DOMAIN + '/' if OSS_PUBLIC_DOMAIN else '/media/')

# Default primary key field type
DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"

# Authentication
AUTH_USER_MODEL = "authentication.User"

# REST Framework
REST_FRAMEWORK = {
    "DEFAULT_AUTHENTICATION_CLASSES": [
        "rest_framework_simplejwt.authentication.JWTAuthentication"
    ],
    "DEFAULT_PERMISSION_CLASSES": [
        "rest_framework.permissions.IsAuthenticated"
    ]
}

# JWT
SIMPLE_JWT = {
    "ACCESS_TOKEN_LIFETIME": timedelta(days=7),  # è®¿é—®ä»¤ç‰Œæœ‰æ•ˆæœŸ
    "REFRESH_TOKEN_LIFETIME": timedelta(days=14),   # åˆ·æ–°ä»¤ç‰Œæœ‰æ•ˆæœŸ
    "ROTATE_REFRESH_TOKENS": True,                 # åˆ·æ–°æ—¶è½®æ¢åˆ·æ–°ä»¤ç‰Œ
    "BLACKLIST_AFTER_ROTATION": True,              # è½®æ¢åå°†æ—§åˆ·æ–°ä»¤ç‰Œæ‹‰é»‘
    "ALGORITHM": "HS256",                          # åŠ å¯†ç®—æ³•
    "AUTH_TOKEN_CLASSES": (
        "rest_framework_simplejwt.tokens.AccessToken",
    ),  # æ˜ç¡®æŒ‡å®štokenç±»å‹
    # --- ç”¨æˆ·IDç›¸å…³é…ç½® ---
    # ä¿®å¤ token_not_valid é—®é¢˜ï¼šç¡®ä¿ JWT èƒ½æ­£ç¡®è¯†åˆ«ç”¨æˆ·æ¨¡å‹çš„ä¸»é”®å­—æ®µ
    "USER_ID_FIELD": "id",       # ç”¨æˆ·æ¨¡å‹çš„ä¸»é”®å­—æ®µåï¼ˆAbstractUser é»˜è®¤ä½¿ç”¨ 'id'ï¼‰
    "USER_ID_CLAIM": "user_id",  # JWT payload ä¸­å­˜å‚¨ç”¨æˆ·IDçš„å­—æ®µå
    # --- End ç”¨æˆ·IDç›¸å…³é…ç½® ---
    # --- Cookieç›¸å…³é…ç½® ---
    # 'AUTH_HEADER_TYPES': ('Bearer',), # é»˜è®¤å€¼ï¼Œå¦‚åªç”¨Cookieå¯ä¿ç•™æˆ–ç§»é™¤
    "AUTH_COOKIE": "access_token",           # JWTè®¿é—®ä»¤ç‰Œçš„Cookieåç§°
    "AUTH_COOKIE_REFRESH": "refresh_token",  # åˆ·æ–°ä»¤ç‰Œçš„Cookieåç§°ï¼ˆå¯é€‰ï¼Œè‹¥é€šè¿‡Cookieå¤„ç†åˆ·æ–°ï¼‰
    "AUTH_COOKIE_HTTP_ONLY": True,           # ä»…HTTPå¯è®¿é—®
    "AUTH_COOKIE_SECURE": not DEBUG,         # ç”Ÿäº§ç¯å¢ƒéœ€ä¸ºTrueï¼ˆéœ€HTTPSï¼‰
    "AUTH_COOKIE_SAMESITE": "Lax",           # Cookie SameSiteå±æ€§ï¼Œå¯é€‰'Strict'æˆ–'None'
    "AUTH_COOKIE_PATH": "/",                 # Cookieè·¯å¾„
    "AUTH_COOKIE_DOMAIN": None,              # ç”Ÿäº§ç¯å¢ƒå¯è®¾ç½®ä¸ºä½ çš„åŸŸåï¼Œå¦‚".example.com"
    # --- End Cookieç›¸å…³é…ç½® ---
}

# Feishu
FEISHU = {
    "APP_ID": os.getenv("FEISHU_APP_ID", ""),
    "APP_SECRET": os.getenv("FEISHU_APP_SECRET", ""),
    "OAUTH": {
        "REDIRECT_URI": f"{os.getenv('SERVER_HOST', 'http://localhost:8000')}/api/access/callback/",  # æŒ‡å‘ access_control åº”ç”¨çš„å¤„ç†å›è°ƒçš„è§†å›¾
        "AUTHORIZATION_URL": "https://accounts.feishu.cn/open-apis/authen/v1/authorize",
        "ACCESS_TOKEN_URL": "https://open.feishu.cn/open-apis/authen/v2/oauth/token",
        "REFRESH_TOKEN_URL": "https://open.feishu.cn/open-apis/authen/v1/refresh_access_token",
        "USER_INFO_URL": "https://open.feishu.cn/open-apis/authen/v1/user_info",
        "SCOPES": [
            "component:user_profile",  # è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
            "contact:contact.base:readonly",  # æŸ¥çœ‹é€šè®¯å½•è”ç³»äººä¿¡æ¯
            "contact:department.base:readonly",  # æŸ¥çœ‹é€šè®¯å½•éƒ¨é—¨ä¿¡æ¯
            "offline_access",  # å…è®¸åˆ·æ–° user_access_tokenï¼Œåœ¨ç”¨æˆ·ç¦»çº¿æ—¶è®¿é—®å·²æˆæƒæ•°æ®
            # äº‘æ–‡æ¡£è¯»å†™æƒé™
            "docs:doc",  # æ—§ç‰ˆæ–‡æ¡£ï¼šå¢åˆ æ”¹æ–‡æ¡£åŠå†…å®¹
            "docx:document",  # æ–°ç‰ˆæ–‡æ¡£ï¼šåˆ›å»ºåŠç¼–è¾‘æ–‡æ¡£
            "sheets:spreadsheet",  # ç”µå­è¡¨æ ¼ï¼šå¢åˆ æ”¹è¡¨æ ¼ã€è¡Œåˆ—æ•°æ®ã€è§†å›¾ç­‰
            "drive:drive",  # äº‘ç©ºé—´ï¼šæŸ¥çœ‹ã€ç¼–è¾‘å’Œç®¡ç†æ‰€æœ‰æ–‡ä»¶
            "wiki:wiki",  # çŸ¥è¯†åº“ï¼šæŸ¥çœ‹ã€ç¼–è¾‘å’Œç®¡ç†çŸ¥è¯†åº“
            # å¤šç»´è¡¨æ ¼æƒé™ï¼ˆé£ä¹¦ä¸æ”¯æŒé€šé…ç¬¦ï¼Œéœ€é€ä¸ªå£°æ˜ï¼‰
            # åº”ç”¨çº§åˆ«
            "base:app:copy",  # å¤åˆ¶å¤šç»´è¡¨æ ¼
            "base:app:create",  # åˆ›å»ºå¤šç»´è¡¨æ ¼
            "base:app:read",  # è·å–å¤šç»´è¡¨æ ¼å…ƒæ•°æ®
            "base:app:update",  # æ›´æ–°å¤šç»´è¡¨æ ¼å…ƒæ•°æ®
            # åä½œè€…ç®¡ç†
            "base:collaborator:create",  # æ–°å¢åä½œè€…
            "base:collaborator:delete",  # åˆ é™¤åä½œè€…
            "base:collaborator:read",  # åˆ—å‡ºåä½œè€…
            # ä»ªè¡¨ç›˜
            "base:dashboard:copy",  # å¤åˆ¶ä»ªè¡¨ç›˜
            "base:dashboard:read",  # è·å–ä»ªè¡¨ç›˜ä¿¡æ¯
            # å­—æ®µç®¡ç†
            "base:field:create",  # æ–°å¢å­—æ®µ
            "base:field:delete",  # åˆ é™¤å­—æ®µ
            "base:field:read",  # è·å–å­—æ®µä¿¡æ¯
            "base:field:update",  # æ›´æ–°å­—æ®µ
            # è¡¨å•ç®¡ç†
            "base:form:read",  # è·å–è¡¨å•æ•°æ®
            "base:form:update",  # æ›´æ–°è¡¨å•æ•°æ®
            # è®°å½•ç®¡ç†
            "base:record:create",  # æ–°å¢è®°å½•
            "base:record:delete",  # åˆ é™¤è®°å½•
            "base:record:read",  # æ£€ç´¢ç‰¹å®šè®°å½•
            "base:record:retrieve",  # æ ¹æ®æ¡ä»¶æœç´¢è®°å½•
            "base:record:update",  # æ›´æ–°è®°å½•
            # è§’è‰²ç®¡ç†
            "base:role:create",  # æ–°å¢è‡ªå®šä¹‰è§’è‰²
            "base:role:delete",  # åˆ é™¤è‡ªå®šä¹‰è§’è‰²
            "base:role:read",  # æŸ¥è¯¢è‡ªå®šä¹‰è§’è‰²
            "base:role:update",  # æ›´æ–°è‡ªå®šä¹‰è§’è‰²
            # æ•°æ®è¡¨ç®¡ç†
            "base:table:create",  # æ–°å¢æ•°æ®è¡¨
            "base:table:delete",  # åˆ é™¤æ•°æ®è¡¨
            "base:table:read",  # è·å–æ•°æ®è¡¨ä¿¡æ¯
            "base:table:update",  # æ›´æ–°æ•°æ®è¡¨
            # è§†å›¾ç®¡ç†
            "base:view:read",  # æ£€ç´¢è§†å›¾
            "base:view:write_only",  # æ–°å¢ã€æ›´æ–°æˆ–åˆ é™¤è§†å›¾
        ],
        "PKCE_ENABLED": True,
    },
}

SERVER_HOST = os.getenv("SERVER_HOST", "http://localhost:8000")  # ç”¨äºç”Ÿæˆå›è°ƒURL

# Logging
# æ—¥å¿—å¤„ç†å™¨é…ç½®è¯´æ˜ï¼š
# 1. console - æ§åˆ¶å°è¾“å‡ºï¼Œå¼€å‘ç¯å¢ƒä½¿ç”¨
# 2. file - æ–‡ä»¶æ—¥å¿—ï¼ŒæŒ‰å¤©è½®è½¬
#    - æ–‡ä»¶åæ ¼å¼: logs/django.log
#    - æ¯å¤©åˆå¤œè½®è½¬
#    - UTF-8ç¼–ç 
#    - ä¿ç•™å¤©æ•°ï¼šæœ¬åœ°å¼€å‘/æµ‹è¯•ç¯å¢ƒ3å¤©ï¼Œç”Ÿäº§ç¯å¢ƒ30å¤©
# æ ¹æ® DEBUG æ¨¡å¼åŠ¨æ€è®¾ç½®æ—¥å¿—çº§åˆ«
LOG_LEVEL = "DEBUG" if DEBUG else "INFO"

# æ ¹æ®ç¯å¢ƒè®¾ç½®æ—¥å¿—ä¿ç•™å¤©æ•°
# ç”Ÿäº§ç¯å¢ƒï¼ˆDEBUG=Falseï¼‰ä¿ç•™30å¤©ï¼Œå¼€å‘/æµ‹è¯•ç¯å¢ƒï¼ˆDEBUG=Trueï¼‰ä¿ç•™3å¤©
LOG_BACKUP_COUNT = 3 if DEBUG else 30

LOGGING = {
    "version": 1,
    "disable_existing_loggers": False,
    "formatters": {
        "standard": {
            "format": "<%(pathname)s:%(lineno)d>\n[%(levelname)s] - %(asctime)s\n======%(funcName)s======\n%(message)s\n",
            "datefmt": "%Y-%m-%d %H:%M:%S %z",
        }
    },
    "handlers": {
        "console": {
            "level": "DEBUG",  # Handler çº§åˆ«è®¾ä¸º DEBUGï¼Œè®© logger çº§åˆ«æ§åˆ¶
            "class": "logging.StreamHandler",
            "formatter": "standard",
        },
        "file": {
            "level": "DEBUG",  # Handler çº§åˆ«è®¾ä¸º DEBUGï¼Œè®© logger çº§åˆ«æ§åˆ¶
            "class": "logging.handlers.TimedRotatingFileHandler",
            "filename": os.path.join(BASE_DIR, "logs/django.log"),
            "when": "midnight",
            "interval": 1,
            "backupCount": LOG_BACKUP_COUNT,
            "formatter": "standard",
            "encoding": "utf-8",
        },
    },
    "loggers": {
        # Django æ¡†æ¶å’Œä¾èµ–åŒ… - ä¿æŒ INFO çº§åˆ«ï¼Œé¿å…è¿‡å¤šè°ƒè¯•ä¿¡æ¯
        "django": {"handlers": ["console", "file"], "level": "INFO", "propagate": False},
        "django.utils.autoreload": {"handlers": ["console", "file"], "level": "WARNING", "propagate": False},  # å±è”½ autoreload çš„ DEBUG æ¶ˆæ¯
        "django.db.backends": {"handlers": ["console", "file"], "level": "WARNING", "propagate": False},  # å±è”½æ•°æ®åº“æŸ¥è¯¢æ—¥å¿—
        
        # Celery ç›¸å…³
        "celery": {"handlers": ["console", "file"], "level": "WARNING", "propagate": False},
        "celery.worker.strategy": {"handlers": ["console", "file"], "level": "WARNING", "propagate": False},
        "celery.app.trace": {"handlers": ["console", "file"], "level": "WARNING", "propagate": False},
        
        # é¡¹ç›®åº”ç”¨ - DEBUG æ¨¡å¼ä¸‹æ˜¾ç¤º DEBUG æ¶ˆæ¯
        "webapps": {"handlers": ["console", "file"], "level": LOG_LEVEL, "propagate": False},
        "agentic": {"handlers": ["console", "file"], "level": LOG_LEVEL, "propagate": False},
        "llm": {"handlers": ["console", "file"], "level": LOG_LEVEL, "propagate": False},
        "knowledge": {"handlers": ["console", "file"], "level": LOG_LEVEL, "propagate": False},
        "tools": {"handlers": ["console", "file"], "level": LOG_LEVEL, "propagate": False},
        "authentication": {"handlers": ["console", "file"], "level": LOG_LEVEL, "propagate": False},
        "payment": {"handlers": ["console", "file"], "level": LOG_LEVEL, "propagate": False},
        "customized": {"handlers": ["console", "file"], "level": LOG_LEVEL, "propagate": False},
        
        # Root logger - æ•è·å…¶ä»–æ‰€æœ‰æ—¥å¿—ï¼ˆç¬¬ä¸‰æ–¹åº“ç­‰ï¼‰ï¼Œä¿æŒ INFO çº§åˆ«
        "": {
            "handlers": ["console", "file"],
            "level": "INFO",  # ç¬¬ä¸‰æ–¹åº“é»˜è®¤ INFO çº§åˆ«
        }
    },
}

# Celery Configuration
# ------------------------------------------------------------------------------
# ä½¿ç”¨ Redis ä½œä¸ºæ¶ˆæ¯ä»£ç† (æ¨èç”¨äºç”Ÿäº§å’Œå¼€å‘ç¯å¢ƒ)
# å»ºè®®ä¸º Celery å•ç‹¬ä½¿ç”¨ä¸€ä¸ª Redis DBï¼Œä¾‹å¦‚ DB 0
# å»ºè®®ä¸º Celery å•ç‹¬ä½¿ç”¨ä¸€ä¸ª Redis DBï¼Œä¾‹å¦‚ DB 0
CELERY_DB = os.getenv("CELERY_DB", "0")
CELERY_BROKER_URL = f"redis://{REDIS_HOST}:{REDIS_PORT}/{CELERY_DB}"
if REDIS_PASSWORD:
    # ä½¿ç”¨ URL ç¼–ç åçš„å¯†ç æ„å»ºè¿æ¥å­—ç¬¦ä¸²
    CELERY_BROKER_URL = f"redis://:{REDIS_PASSWORD_QUOTED}@{REDIS_HOST}:{REDIS_PORT}/{CELERY_DB}"
CELERY_BROKER_TRANSPORT_OPTIONS = {"visibility_timeout": 3600}  # 1 hour

# ç»“æœåç«¯æ”¹ç”¨ Redisï¼ˆæ¨èæ–¹æ¡ˆï¼šè‡ªåŠ¨è¿‡æœŸï¼Œæ€§èƒ½æ›´å¥½ï¼‰
# ä½¿ç”¨ä¸åŒçš„ Redis DBï¼ˆ2ï¼‰æ¥å­˜å‚¨ç»“æœï¼Œé¿å…ä¸ Brokerï¼ˆDB 0ï¼‰æ··æ·†
CELERY_RESULT_DB = os.getenv("CELERY_RESULT_DB", "2")
CELERY_RESULT_BACKEND = f"redis://{REDIS_HOST}:{REDIS_PORT}/{CELERY_RESULT_DB}"
if REDIS_PASSWORD:
    CELERY_RESULT_BACKEND = f"redis://:{REDIS_PASSWORD_QUOTED}@{REDIS_HOST}:{REDIS_PORT}/{CELERY_RESULT_DB}"

# å¦‚æœéœ€è¦ç»§ç»­ä½¿ç”¨æ•°æ®åº“å­˜å‚¨ï¼ˆä¸æ¨èï¼‰ï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Šï¼š
# CELERY_RESULT_BACKEND = 'django-db'
CELERY_ACCEPT_CONTENT = ['json']
CELERY_TASK_SERIALIZER = 'json'
CELERY_RESULT_SERIALIZER = 'json'
CELERY_TIMEZONE = TIME_ZONE

# Celery ä¼˜åŒ–é…ç½®ï¼ˆæ”¯æŒé«˜å¹¶å‘ï¼‰
# å›ºå®šä½¿ç”¨ gevent æ± é…ç½®
# CELERY_WORKER_POOL = 'gevent'  # ä½¿ç”¨ -P gevent å‘½ä»¤è¡Œå‚æ•°ä»£æ›¿
CELERY_WORKER_MAX_TASKS_PER_CHILD = 1000  # å®šæœŸå›æ”¶ worker
CELERY_BROKER_POOL_LIMIT = None  # ç¦ç”¨è¿æ¥æ± é™åˆ¶
CELERY_RESULT_BACKEND_POOL_LIMIT = None
CELERY_WORKER_PREFETCH_MULTIPLIER = 4  # å¢åŠ é¢„å–ï¼Œæé«˜ä»»åŠ¡å¤„ç†æ•ˆç‡ï¼ˆ170 QPSï¼‰

# Celery ç»“æœè¿‡æœŸé…ç½®
CELERY_RESULT_EXPIRES = 86400  # 24å°æ—¶åè‡ªåŠ¨è¿‡æœŸï¼ˆRedis ä¼šè‡ªåŠ¨æ¸…ç†ï¼‰
# æ³¨ï¼šä½¿ç”¨ Redis åç«¯æ—¶ï¼Œè¿‡æœŸçš„ç»“æœä¼šè‡ªåŠ¨è¢« Redis æ¸…ç†ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„

# Celery é˜Ÿåˆ—é…ç½®
# ------------------------------------------------------------------------------
# å®šä¹‰é˜Ÿåˆ—é…ç½®ï¼ˆæ‰€æœ‰é˜Ÿåˆ—å…±äº«åŒä¸€ä¸ª broker DBï¼‰
from kombu import Queue, Exchange

CELERY_TASK_QUEUES = (
    # é»˜è®¤é˜Ÿåˆ—ï¼šå¤„ç†ä¸€èˆ¬ä»»åŠ¡
    Queue('celery', Exchange('celery'), routing_key='celery',
          queue_arguments={'x-max-priority': 10}),

    # PDF Extractor é˜Ÿåˆ—ï¼šå¤„ç† PDF æå–ä»»åŠ¡
    Queue('pdf_extractor', Exchange('pdf_extractor'), routing_key='pdf_extractor',
          queue_arguments={'x-max-priority': 10}),
)

# ä»»åŠ¡è·¯ç”±é…ç½®ï¼šå°†ç‰¹å®šä»»åŠ¡è·¯ç”±åˆ°æŒ‡å®šé˜Ÿåˆ—
CELERY_TASK_ROUTES = {
    # PDF Extractor ç›¸å…³ä»»åŠ¡è·¯ç”±åˆ° pdf_extractor é˜Ÿåˆ—
    'toolkit.process_pdf_extraction': {
        'queue': 'pdf_extractor',
        'routing_key': 'pdf_extractor',
    },
    'toolkit.cleanup_old_tasks': {
        'queue': 'pdf_extractor',
        'routing_key': 'pdf_extractor',
    },
}

# é»˜è®¤é˜Ÿåˆ—
CELERY_TASK_DEFAULT_QUEUE = 'celery'
CELERY_TASK_DEFAULT_EXCHANGE = 'celery'
CELERY_TASK_DEFAULT_ROUTING_KEY = 'celery'

# Celery Beat å®šæ—¶ä»»åŠ¡é…ç½®
CELERY_BEAT_SCHEDULE = {
    'check-and-flush-callbacks': {
        'task': 'customized.image_editor.tasks_batch.check_and_flush_callbacks',
        'schedule': 3.0,  # æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡
        'options': {'queue': 'celery'}
    },
    'cleanup-stuck-callbacks': {
        'task': 'customized.image_editor.tasks_batch.cleanup_stuck_callbacks',
        'schedule': 300.0,  # æ¯5åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
        'options': {'queue': 'celery'}
    },
    'check-download-heartbeat': {
        'task': 'dataset_downloader.tasks.check_heartbeat_timeout',
        'schedule': 60.0,
        'options': {'queue': 'celery'}
    }
}

# MinerU é…ç½®
MINERU_SETTINGS = {
    'OUTPUT_DIR': os.path.join(BASE_DIR, 'mineru', 'outputs'),
    'UPLOAD_DIR': os.path.join(BASE_DIR, 'mineru', 'uploads'),
    'TEMP_DIR': os.path.join(BASE_DIR, 'mineru', 'temp'),
    'MAX_FILE_SIZE': 100 * 1024 * 1024,  # 100MB
    'ALLOWED_FILE_TYPES': ['pdf', 'jpg', 'png', 'doc', 'docx', 'ppt', 'pptx'],
    'GPU_ENABLED': GPU_AVAILABLE,
    'MODEL_SOURCE': os.getenv('MINERU_MODEL_SOURCE', 'local'),
    # MinerU v2.2 æ–°ç‰¹æ€§
    'ENABLE_TABLE_MERGE': True,  # å¯ç”¨è·¨é¡µè¡¨æ ¼åˆå¹¶
    'USE_NEW_TABLE_MODEL': True,  # ä½¿ç”¨æ–°çš„è¡¨æ ¼è¯†åˆ«æ¨¡å‹
    'SUPPORT_LANGUAGES': ['en', 'zh', 'th', 'el'],  # v2.2æ–°å¢: æ³°è¯­å’Œå¸Œè…Šè¯­OCRæ”¯æŒ
    # å­˜å‚¨ä¼˜åŒ–é…ç½®
    'USE_OSS': os.getenv('MINERU_USE_OSS', 'true').lower() == 'true',  # å¯ç”¨ OSS å­˜å‚¨
    'CACHE_ENABLED': True,  # å¯ç”¨ç¼“å­˜
    'CACHE_EXPIRE_DAYS': 7,  # ç¼“å­˜è¿‡æœŸå¤©æ•°
}

# WhiteNoise é…ç½®
# å¯ç”¨é™æ€æ–‡ä»¶å‹ç¼©å’Œç¼“å­˜
WHITENOISE_AUTOREFRESH = DEBUG  # å¼€å‘ç¯å¢ƒè‡ªåŠ¨åˆ·æ–°
WHITENOISE_USE_FINDERS = DEBUG  # å¼€å‘ç¯å¢ƒä» STATICFILES_DIRS æŸ¥æ‰¾æ–‡ä»¶
WHITENOISE_COMPRESS_OFFLINE = not DEBUG  # ç”Ÿäº§ç¯å¢ƒå¯ç”¨å‹ç¼©

# Payment æ”¯ä»˜æ¨¡å—é…ç½®
BACKEND_API_URL = os.getenv('SERVER_HOST', 'http://localhost:8000')

PAYMENT_SETTINGS = {
    # åç«¯åœ°å€é…ç½®ï¼ˆç”¨äºå¼‚æ­¥å›è°ƒé€šçŸ¥ï¼‰
    'BACKEND_API_URL': BACKEND_API_URL,
    
    # æ”¯ä»˜è®¢å•é»˜è®¤è¿‡æœŸæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
    'ORDER_EXPIRE_MINUTES': int(os.getenv('PAYMENT_ORDER_EXPIRE_MINUTES', '30')),
    
    # è™çš®æ¤’æ”¯ä»˜é…ç½®ï¼ˆå¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–ï¼Œä¹Ÿå¯åœ¨æ•°æ®åº“ä¸­é…ç½®ï¼‰
    'HUPIJIAO': {
        'APP_ID': os.getenv('HUPIJIAO_APP_ID', ''),
        'APP_SECRET': os.getenv('HUPIJIAO_APP_SECRET', ''),
        'API_URL': os.getenv('HUPIJIAO_API_URL', 'https://api.xunhupay.com/payment/do.html'),
        'TEST_MODE': os.getenv('HUPIJIAO_TEST_MODE', 'True').lower() == 'true',
    },
    
    # æ”¯ä»˜æ—¥å¿—çº§åˆ«
    'LOG_LEVEL': os.getenv('PAYMENT_LOG_LEVEL', 'INFO'),
}

# Email Configuration
# ------------------------------------------------------------------------------
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = os.getenv('EMAIL_HOST', 'smtp.gmail.com')
EMAIL_PORT = int(os.getenv('EMAIL_PORT', '587'))
# QQä¼ä¸šé‚®ç®±ä½¿ç”¨SSLï¼Œç«¯å£465
EMAIL_USE_TLS = os.getenv('EMAIL_USE_TLS', 'False').lower() == 'true'
EMAIL_USE_SSL = os.getenv('EMAIL_USE_SSL', 'True').lower() == 'true'
EMAIL_HOST_USER = os.getenv('EMAIL_HOST_USER', '')
EMAIL_HOST_PASSWORD = os.getenv('EMAIL_HOST_PASSWORD', '')
DEFAULT_FROM_EMAIL = os.getenv('DEFAULT_FROM_EMAIL', 'noreply@example.com')

# é‚®ç®±éªŒè¯ç é…ç½®
EMAIL_VERIFICATION_CODE_LENGTH = 6
EMAIL_VERIFICATION_CODE_EXPIRE_MINUTES = 10

# ç«™ç‚¹ä¿¡æ¯
SITE_NAME = os.getenv('SITE_NAME', 'Agentic AI Platform')
