# TODO List - 2025-08-26

## 支付金额安全验证

### 背景描述
当前支付金额由前端直接传递，存在被篡改的风险。需要在后端根据产品ID查询真实价格，防止恶意用户修改金额。

### 环境背景
- 检查支付服务运行状态：`ps aux | grep gunicorn`
- 确认端口占用：`lsof -i :6066`
- 数据库连接：`python manage.py dbshell`

### 任务清单
- [ ] 创建产品价格配置模型（Product）
- [ ] 在创建订单时验证金额与产品ID是否匹配
- [ ] 记录金额不匹配的异常日志
- [ ] 添加单元测试验证金额校验逻辑

### 相关文件
- `services.py:75-82` - create_order方法需要添加金额验证
- `models.py` - 需要添加Product模型
- `tests.py` - 添加金额验证的测试用例

---

## 订单查询权限控制

### 背景描述
当前订单查询接口缺少权限验证，任何用户可能通过订单号查询其他用户的订单信息，存在信息泄露风险。

### 任务清单
- [ ] 在query_status视图添加用户权限检查
- [ ] 确保普通用户只能查询自己的订单
- [ ] 管理员可以查询所有订单
- [ ] 添加权限验证失败的日志记录

### 相关文件
- `views.py:101-136` - query_status方法需要添加权限验证
- `serializers.py:140-144` - PaymentStatusSerializer可能需要扩展

---

## 支付回调URL安全验证

### 背景描述
支付回调URL需要验证是否在允许的域名白名单内，防止恶意回调和重定向攻击。

### 任务清单
- [ ] 创建域名白名单配置（ALLOWED_CALLBACK_DOMAINS）
- [ ] 在serializer中添加URL域名验证逻辑
- [ ] 验证notify_url、return_url、callback_url的域名
- [ ] 记录非法域名访问日志

### 相关文件
- `serializers.py:64-82` - 需要添加URL域名验证逻辑
- `settings.py` - 添加ALLOWED_CALLBACK_DOMAINS配置

---

## 双域名配置支持

### 背景描述
由于支付平台域名登记限制，需要支持用户访问域名和支付回调域名分离。用户看到的链接使用用户域名，支付平台回调使用登记域名。

### 任务清单
- [ ] 修改CreatePaymentOrderSerializer，添加payment_callback_base字段
- [ ] 在create_order服务中使用payment_callback_base构建notify_url
- [ ] 确保return_url和callback_url使用frontend_url
- [ ] 更新文档说明双域名配置方式

### 相关文件
- `serializers.py:33-89` - CreatePaymentOrderSerializer需要添加新字段
- `services.py:140-145` - 修改notify_url的构建逻辑

### 修改示例
```python
# serializers.py
class CreatePaymentOrderSerializer(serializers.Serializer):
    # ... 现有字段 ...
    payment_callback_base = serializers.URLField(
        required=False,
        allow_blank=True,
        help_text='支付回调基础URL，用于构建notify_url（支付平台登记域名）'
    )

# services.py - create_order方法
# 使用payment_callback_base构建notify_url
payment_callback_base = kwargs.get('payment_callback_base')
if payment_callback_base:
    notify_url = f"{payment_callback_base}/api/payment/callback/notify/"
else:
    # 使用默认后端地址
    notify_url = self.get_default_notify_url()
```

---

## URL分离策略实施

### 背景描述
需要明确区分用户可见URL（用于页面跳转）和支付回调URL（用于接收支付平台通知），确保支付域名不出现在用户可见的链接中。

### 任务清单
- [ ] 确保notify_url仅使用payment_callback_base域名
- [ ] 确保return_url使用frontend_url（用户域名）
- [ ] 确保callback_url使用frontend_url（用户域名）
- [ ] 在日志中区分不同类型的URL

### 相关文件
- `services.py:140-145` - notify_url、return_url、callback_url的构建逻辑
- `views.py:61-98` - create_order视图的URL处理

### 修改示例
```python
# services.py
# 构建不同用途的URL
notify_url = f"{payment_callback_base}/api/payment/callback/notify/"  # 支付回调
return_url = f"{frontend_url}/subscription/success"  # 用户跳转（成功）
callback_url = f"{frontend_url}/subscription/fail"   # 用户跳转（失败）
```