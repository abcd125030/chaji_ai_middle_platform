# æ”¯ä»˜æ¨¡å—å½“å‰å®ç°çŠ¶æ€

## æ¨¡å—ä½ç½®
`backend/webapps/payment/`

## æ ¸å¿ƒåŠŸèƒ½å®ç°çŠ¶æ€

### 1. æ•°æ®æ¨¡å‹å±‚ (models.py)

#### æ•°æ®æ¨¡å‹ERå…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¦ authentication.User         â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ ğŸ”‘ id                           â”‚
â”‚ ğŸ“ username                     â”‚
â”‚ ğŸ“ email                        â”‚
â”‚ ğŸ“ first_name                   â”‚
â”‚ ğŸ“ last_name                    â”‚
â”‚ âœ… is_active                    â”‚
â”‚ ğŸ• date_joined                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ 1:N (user)
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¦ payment.PaymentOrder        â”‚        â”‚  ğŸ“¦ payment.PaymentConfig       â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ ğŸ”‘ id                           â”‚        â”‚ ğŸ”‘ id                           â”‚
â”‚ ğŸ” order_id (unique)            â”‚        â”‚ ğŸ” provider (unique)            â”‚
â”‚ ğŸ”— user_id â†’ User               â”‚        â”‚ ğŸ“ app_id                       â”‚
â”‚ ğŸ“ payment_method               â”‚        â”‚ ğŸ”’ app_secret                   â”‚
â”‚ ğŸ’° amount (Decimal)             â”‚        â”‚ ğŸŒ api_url                      â”‚
â”‚ ğŸ“ title                        â”‚        â”‚ âœ… is_active                    â”‚
â”‚ ğŸ“ description                  â”‚        â”‚ ğŸ§ª is_test_mode                 â”‚
â”‚ ğŸ“Š status                       â”‚        â”‚ ğŸ“‹ extra_config (JSON)          â”‚
â”‚ ğŸŒ pay_url                      â”‚        â”‚ ğŸ• created_at                   â”‚
â”‚ ğŸŒ notify_url                   â”‚        â”‚ ğŸ• updated_at                   â”‚
â”‚ ğŸŒ return_url                   â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ ğŸŒ callback_url                 â”‚                      â¬†
â”‚ ğŸ“ external_order_id            â”‚         è¢« HupijiaoPaymentService è¯»å–
â”‚ ğŸ• expire_at                    â”‚
â”‚ ğŸ• paid_at                      â”‚
â”‚ ğŸ“‹ metadata (JSON)              â”‚
â”‚ ğŸ• created_at                   â”‚
â”‚ ğŸ• updated_at                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚
        â”‚ 1:N           â”‚ order_id (è½¯å…³è”)
        â†“               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¦ payment.PaymentLog          â”‚        â”‚  ğŸ“¦ payment.PaymentCallback     â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ ğŸ”‘ id                           â”‚        â”‚ ğŸ”‘ id                           â”‚
â”‚ ğŸ”— order_id â†’ PaymentOrder      â”‚        â”‚ ğŸ“ order_id (CharField)         â”‚
â”‚    (CASCADE)                    â”‚        â”‚ ğŸ“ callback_type                â”‚
â”‚ ğŸ“ log_type                     â”‚        â”‚ ğŸ“‹ raw_data (JSON)              â”‚
â”‚ ğŸ“ message                      â”‚        â”‚ ğŸ”’ signature                    â”‚
â”‚ ğŸ“‹ request_data (JSON)          â”‚        â”‚ âœ… is_valid                     â”‚
â”‚ ğŸ“‹ response_data (JSON)         â”‚        â”‚ ğŸ• created_at                   â”‚
â”‚ ğŸ• created_at                   â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å›¾ä¾‹ï¼š
ğŸ”‘ ä¸»é”®  ğŸ” å”¯ä¸€ç´¢å¼•  ğŸ”— å¤–é”®  ğŸ“ å­—ç¬¦å­—æ®µ  ğŸ’° é‡‘é¢å­—æ®µ  
ğŸ“Š çŠ¶æ€å­—æ®µ  ğŸŒ URLå­—æ®µ  ğŸ“‹ JSONå­—æ®µ  ğŸ• æ—¶é—´å­—æ®µ  
âœ… å¸ƒå°”å­—æ®µ  ğŸ§ª æµ‹è¯•æ ‡è¯†  ğŸ”’ æ•æ„Ÿå­—æ®µ
```

#### è·¨åº”ç”¨æ•°æ®å…³è”

##### 1. authentication.User â†’ payment.PaymentOrder
- **å…³è”ç±»å‹**: ä¸€å¯¹å¤šå…³ç³»ï¼ˆä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªæ”¯ä»˜è®¢å•ï¼‰
- **å¤–é”®å­—æ®µ**: `PaymentOrder.user_id`
- **çº§è”è¡Œä¸º**: PROTECTï¼ˆç”¨æˆ·åˆ é™¤æ—¶ä¿æŠ¤è®¢å•æ•°æ®ï¼‰
- **åå‘æŸ¥è¯¢**: `user.payment_orders.all()`

##### 2. æ½œåœ¨çš„è·¨åº”ç”¨å…³è”ï¼ˆå·²è¯†åˆ«ä½†æœªå®ç°ï¼‰
- `chat_sessions.ChatSession` â†’ `PaymentOrder`ï¼šä¼šè¯ä»˜è´¹åŠŸèƒ½
- `knowledge.KnowledgeCollection` â†’ `PaymentOrder`ï¼šçŸ¥è¯†åº“ä»˜è´¹åŠŸèƒ½
- `agentic.WorkflowExecution` â†’ `PaymentOrder`ï¼šå·¥ä½œæµè®¡è´¹åŠŸèƒ½

#### æ•°æ®æ¨¡å‹è¯¦ç»†è¯´æ˜

##### PaymentOrder - æ”¯ä»˜è®¢å•ä¸»è¡¨
**è¡¨å**: `payment_orders`  
**ç”¨é€”**: è®°å½•æ‰€æœ‰æ”¯ä»˜äº¤æ˜“çš„æ ¸å¿ƒä¿¡æ¯

**å­—æ®µè¯´æ˜**:
- `order_id`: ä¸šåŠ¡ä¸»é”®ï¼Œæ ¼å¼ `PAY{timestamp}{8ä½éšæœºå­—ç¬¦}`
- `user_id`: å¤–é”®å…³è” `authentication.User`
- `payment_method`: ENUM('wechat', 'alipay')
- `amount`: DECIMAL(10,2) æ”¯æŒæœ€å¤§ 99,999,999.99
- `status`: ENUM('pending', 'processing', 'success', 'failed', 'cancelled', 'refunded')
- `expire_at`: è‡ªåŠ¨è®¡ç®— = created_at + 30åˆ†é’Ÿ
- `external_order_id`: ç¬¬ä¸‰æ–¹å¹³å°è¿”å›çš„è®¢å•å·

##### PaymentCallback - æ”¯ä»˜å›è°ƒè®°å½•è¡¨
**è¡¨å**: `payment_callbacks`  
**ç”¨é€”**: å®¡è®¡æ‰€æœ‰ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°çš„å›è°ƒè¯·æ±‚

**ç‰¹ç‚¹**:
- ä½¿ç”¨ `order_id` å­—ç¬¦ä¸²å…³è”è€Œéå¤–é”®ï¼ˆä¿è¯æ•°æ®å®Œæ•´æ€§ï¼‰
- ä¿å­˜å®Œæ•´çš„ `raw_data` ç”¨äºé—®é¢˜æ’æŸ¥
- `is_valid` è®°å½•ç­¾åéªŒè¯ç»“æœ

##### PaymentConfig - æ”¯ä»˜é…ç½®ç®¡ç†è¡¨
**è¡¨å**: `payment_configs`  
**ç”¨é€”**: ç®¡ç†å¤šæ”¯ä»˜æ¸ é“çš„é…ç½®ä¿¡æ¯

**çº¦æŸ**:
- `provider` å­—æ®µå”¯ä¸€çº¦æŸ
- åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ª `is_active=True` çš„é…ç½®

##### PaymentLog - æ”¯ä»˜æ“ä½œæ—¥å¿—è¡¨
**è¡¨å**: `payment_logs`  
**ç”¨é€”**: è¯¦ç»†è®°å½•æ”¯ä»˜è¿‡ç¨‹ä¸­çš„æ‰€æœ‰æ“ä½œ

**çº§è”å…³ç³»**:
- ä¸ `PaymentOrder` å¼ºå…³è”ï¼ˆCASCADEåˆ é™¤ï¼‰
- `log_type` åŒºåˆ†ï¼šrequest/response/callback/error

### 2. æœåŠ¡å±‚ (services.py)
#### HupijiaoPaymentService - è™çš®æ¤’æ”¯ä»˜æœåŠ¡
**é…ç½®è¯»å–æœºåˆ¶ï¼š**
- ä»æ•°æ®åº“ `PaymentConfig` æ¨¡å‹è¯»å–é…ç½®
- è¦æ±‚é…ç½®å¿…é¡»å­˜åœ¨ä¸” `is_active=True`

**å·²å®ç°åŠŸèƒ½ï¼š**
- MD5ç­¾åç”Ÿæˆä¸éªŒè¯
- åˆ›å»ºæ”¯ä»˜è®¢å•ï¼ˆç”Ÿæˆæ”¯ä»˜é“¾æ¥ï¼‰
- è®¢å•çŠ¶æ€æŸ¥è¯¢
- æ”¯ä»˜å›è°ƒå¤„ç†ï¼ˆå¼‚æ­¥é€šçŸ¥ã€åŒæ­¥è¿”å›ï¼‰
- è‡ªåŠ¨è®°å½•æ‰€æœ‰äº¤äº’æ—¥å¿—

### 3. APIæ¥å£å±‚ (views.py)
#### å·²å®ç°æ¥å£
- `POST /api/payment/create/` - åˆ›å»ºæ”¯ä»˜è®¢å•
  - å¿…éœ€å‚æ•°ï¼špayment_method, amount, title, frontend_url
  - è¿”å›ï¼šè®¢å•IDã€æ”¯ä»˜é“¾æ¥ã€è¿‡æœŸæ—¶é—´

- `GET /api/payment/orders/` - æŸ¥è¯¢ç”¨æˆ·è®¢å•åˆ—è¡¨
  - æ”¯æŒåˆ†é¡µã€çŠ¶æ€ç­›é€‰
  - æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—

- `GET /api/payment/orders/{order_id}/` - æŸ¥è¯¢è®¢å•è¯¦æƒ…
  - è¿”å›å®Œæ•´è®¢å•ä¿¡æ¯å’Œæ—¥å¿—

- `POST /api/payment/orders/{order_id}/query/` - ä¸»åŠ¨æŸ¥è¯¢è®¢å•çŠ¶æ€
  - å‘æ”¯ä»˜å¹³å°æŸ¥è¯¢æœ€æ–°çŠ¶æ€å¹¶åŒæ­¥

- `POST /api/payment/callback/notify/` - å¤„ç†å¼‚æ­¥æ”¯ä»˜é€šçŸ¥
  - éªŒè¯ç­¾åã€æ›´æ–°è®¢å•çŠ¶æ€
  - å…è®¤è¯æ¥å£ï¼ˆä¾›ç¬¬ä¸‰æ–¹è°ƒç”¨ï¼‰

- `GET /api/payment/callback/return/` - å¤„ç†åŒæ­¥è¿”å›
  - éªŒè¯ç­¾åã€è®°å½•å›è°ƒ
  - é‡å®šå‘åˆ°å‰ç«¯ç»“æœé¡µé¢

### 4. ç®¡ç†åå° (admin.py)
#### Django Adminé…ç½®
- æ”¯ä»˜è®¢å•ç®¡ç†ï¼šçŠ¶æ€é¢œè‰²æ ‡è®°ã€é‡‘é¢æ ¼å¼åŒ–æ˜¾ç¤º
- æ”¯ä»˜é…ç½®ç®¡ç†ï¼šæµ‹è¯•æ¨¡å¼åˆ‡æ¢ã€æ¿€æ´»çŠ¶æ€æ§åˆ¶
- å›è°ƒè®°å½•æŸ¥çœ‹ï¼šåŸå§‹æ•°æ®å±•ç¤º
- æ—¥å¿—æŸ¥è¯¢ï¼šæŒ‰ç±»å‹ã€æ—¶é—´ç­›é€‰

### 5. æ•°æ®åº“é…ç½®ç°çŠ¶

#### å½“å‰è™çš®æ¤’é…ç½®
```
Provider: hupijiao
App ID: 201906154802
App Secret: ef2db10317***ï¼ˆå·²é…ç½®ï¼‰
API URL: https://api.xunhupay.com/payment/do.html
æ¿€æ´»çŠ¶æ€: âœ… å·²æ¿€æ´»
è¿è¡Œæ¨¡å¼: âš ï¸ æµ‹è¯•æ¨¡å¼
æœ€åæ›´æ–°: 2025-08-26 02:04:02
```

### 6. é›†æˆè¦æ±‚

#### å‰ç«¯è°ƒç”¨æµç¨‹
1. è°ƒç”¨ `/api/payment/create/` åˆ›å»ºè®¢å•
2. è·å– `pay_url` è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
3. æ”¯ä»˜å®Œæˆåè‡ªåŠ¨è·³è½¬å› `return_url`
4. å‰ç«¯é€šè¿‡ `/api/payment/orders/{order_id}/` ç¡®è®¤æœ€ç»ˆçŠ¶æ€

#### å¿…éœ€çš„å‰ç«¯å‚æ•°
- `frontend_url`: å‰ç«¯åŸºç¡€URLï¼ˆç”¨äºæ„å»ºå›è°ƒåœ°å€ï¼‰
- `payment_method`: æ”¯ä»˜æ–¹å¼ï¼ˆwechat/alipayï¼‰
- `amount`: æ”¯ä»˜é‡‘é¢
- `title`: è®¢å•æ ‡é¢˜

### 7. å®‰å…¨æœºåˆ¶
- MD5ç­¾åéªŒè¯æ‰€æœ‰å›è°ƒè¯·æ±‚
- è®¢å•é‡‘é¢ä¸å¯ä¿®æ”¹
- æ”¯ä»˜çŠ¶æ€å•å‘æµè½¬ï¼ˆä¸å¯å›é€€ï¼‰
- æ•æ„Ÿé…ç½®å­˜å‚¨åœ¨æ•°æ®åº“ï¼ˆéä»£ç åº“ï¼‰
- å®Œæ•´çš„æ“ä½œæ—¥å¿—å®¡è®¡

### 8. æµ‹è¯•èµ„æº
- é›†æˆæµ‹è¯•è„šæœ¬ï¼š`backend/hupijiao-v3-python.py`
- ç‹¬ç«‹æµ‹è¯•é¡¹ç›®ï¼š`notebook/wechat_payment_test/`
- ç®¡ç†å‘½ä»¤ï¼š`python manage.py init_payment_config`

## ä¾èµ‹å…³ç³»
- Django REST Framework - APIæ¥å£
- PostgreSQL - æ•°æ®å­˜å‚¨
- requests - HTTPè¯·æ±‚
- hashlib - ç­¾åç”Ÿæˆ

## å½“å‰é™åˆ¶
- ä»…æ”¯æŒè™çš®æ¤’ä¸€ä¸ªæ”¯ä»˜æ¸ é“
- æœªå®ç°é€€æ¬¾åŠŸèƒ½
- æœªå®ç°å¯¹è´¦åŠŸèƒ½
- è®¢å•è¿‡æœŸæ—¶é—´å›ºå®š30åˆ†é’Ÿ

## æ•°æ®åº“è¿ç§»çŠ¶æ€
- åˆå§‹è¿ç§»ï¼š`0001_initial.py` âœ… å·²åº”ç”¨
- æ•°æ®è¡¨ï¼š`payment_orders`, `payment_callbacks`, `payment_configs`, `payment_logs` âœ… å·²åˆ›å»º