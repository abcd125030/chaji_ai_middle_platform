# Webé¡µé¢åˆ°Agentæ•°æ®çš„å­—æ®µæ˜ å°„å…³ç³»å›¾

## æ•°æ®æµè½¬çš„å±æ€§çº§æ˜ å°„

### æ–¹æ¡ˆ1: ä½¿ç”¨flowchartå­å›¾å’Œæ˜ç¡®è¿çº¿

```mermaid
flowchart TB
    subgraph Web["ğŸŒ Webé¡µé¢ (page.tsx)"]
        W1[message: string]
        W2[activeMode: string]
        W3[uploadedFiles: Array]
    end
    
    subgraph API["ğŸ“¡ APIè·¯ç”± (route.ts)"]
        A1[message: string]
        A2[mode: string]
        A3[files: Array]
        A4[sessionId: UUID]
    end
    
    subgraph Django["ğŸ”§ Djangoè§†å›¾ (views.py)"]
        D1[message/content: string]
        D2[activeMode: string]
        D3[files: SimpleUploadedFile]
        D4[session_id: UUID]
        D5[request.user: User]
    end
    
    subgraph Service["âš™ï¸ ChatService"]
        S1[session: ChatSession]
        S2[message: string]
        S3[files: List Dict]
        S4[active_mode: string]
        S5[user: User]
    end
    
    subgraph Agent["ğŸ¤– AgentService"]
        AG1[session_id: string]
        AG2[messages: List Dict]
        AG3[files: List Dict]
        AG4[graph_name: string]
        AG5[usage: string/None]
    end
    
    %% è¿æ¥çº¿
    W1 --> A1
    W2 --> A2
    W3 --> A3
    
    A1 --> D1
    A2 --> D2
    A3 --> D3
    A4 --> D4
    
    D1 --> S2
    D2 --> S4
    D3 --> S3
    D4 --> S1
    D5 --> S5
    
    S1 --> AG1
    S2 --> AG2
    S3 --> AG3
    S4 --> AG5
    
    %% æ ·å¼
    style Web fill:#e3f2fd
    style API fill:#f3e5f5
    style Django fill:#fff3e0
    style Service fill:#e8f5e9
    style Agent fill:#fce4ec
```

### æ–¹æ¡ˆ2: ä½¿ç”¨è¡¨è¾¾å¼é£æ ¼çš„æ˜ å°„å›¾

```mermaid
flowchart TB
    subgraph mapping["ğŸ”„ å­—æ®µæ˜ å°„å…³ç³»"]
        direction TB
        
        subgraph step1["ç¬¬1æ­¥: Web â†’ API"]
            m1["activeMode âœ mode"]
            m2["uploadedFiles âœ files"]
            m3["message âœ message (ä¿æŒä¸å˜)"]
        end
        
        subgraph step2["ç¬¬2æ­¥: API â†’ Django"]
            m4["mode âœ activeMode (æ¢å¤)"]
            m5["files[].data (base64) âœ SimpleUploadedFile"]
            m6["sessionId (URL) âœ session_id"]
        end
        
        subgraph step3["ç¬¬3æ­¥: Django â†’ ChatService"]
            m7["session_id âœ ChatSessionå¯¹è±¡ (æ•°æ®åº“æŸ¥è¯¢)"]
            m8["SimpleUploadedFile âœ æ–‡ä»¶è·¯å¾„ä¿¡æ¯"]
            m9["request.user âœ user (ä¼ é€’)"]
        end
        
        subgraph step4["ç¬¬4æ­¥: ChatService â†’ AgentService"]
            m10["ChatSession.id âœ session_id (UUIDâ†’string)"]
            m11["active_mode='research' âœ usage='deep_research'"]
            m12["æ¶ˆæ¯å†å² âœ messagesåˆ—è¡¨"]
        end
    end
    
    style step1 fill:#e1f5fe
    style step2 fill:#f3e5f5
    style step3 fill:#fff3e0
    style step4 fill:#e8f5e9
```

### æ–¹æ¡ˆ3: ä½¿ç”¨ç®€åŒ–çš„å‚ç›´æµç¨‹å›¾

```mermaid
flowchart TB
    %% èŠ‚ç‚¹å®šä¹‰
    Web["<b>ğŸŒ Webé¡µé¢</b><br/>message | activeMode | uploadedFiles"]
    API["<b>ğŸ“¡ APIè·¯ç”±</b><br/>message | mode | files | sessionId"]
    Django["<b>ğŸ”§ Djangoè§†å›¾</b><br/>message | activeMode | files | session_id | user"]
    ChatService["<b>âš™ï¸ ChatService</b><br/>session | message | files | active_mode | user"]
    AgentService["<b>ğŸ¤– AgentService</b><br/>session_id | messages | files | graph_name | usage"]
    AgentTask["<b>ğŸ’¾ AgentTask</b><br/>task_id | user | status | input_data | state_snapshot"]
    ChatMessage["<b>ğŸ’¬ ChatMessage</b><br/>content | role | task_id | files_info | task_steps"]
    
    %% è¿æ¥å’Œæ ‡æ³¨
    Web -->|"activeModeâ†’mode"| API
    API -->|"modeâ†’activeMode<br/>æ·»åŠ session_id"| Django
    Django -->|"æ–‡ä»¶ä¿å­˜<br/>è·¯å¾„ä¼ é€’"| ChatService
    ChatService -->|"æ„å»ºmessages<br/>modeâ†’usage"| AgentService
    AgentService -->|"åˆ›å»ºä»»åŠ¡"| AgentTask
    ChatService -.->|"åˆ›å»ºæ¶ˆæ¯"| ChatMessage
    AgentTask -.->|"task_idå…³è”"| ChatMessage
    
    %% æ ·å¼
    style Web fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style API fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    style Django fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    style ChatService fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    style AgentService fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    style AgentTask fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    style ChatMessage fill:#e0f2f1,stroke:#00796b,stroke-width:2px
```

### æ–¹æ¡ˆ4: æ•°æ®è½¬æ¢æµç¨‹å›¾

```mermaid
flowchart TB
    subgraph Input["ğŸ“¥ ç”¨æˆ·è¾“å…¥"]
        UI[ç”¨æˆ·åœ¨é¡µé¢è¾“å…¥æ¶ˆæ¯å’Œä¸Šä¼ æ–‡ä»¶]
    end
    
    subgraph Transform["ğŸ”„ æ•°æ®è½¬æ¢è¿‡ç¨‹"]
        T1[æ–‡ä»¶: Fileå¯¹è±¡ â†’ Base64ç¼–ç ]
        T2[æ¨¡å¼: activeMode â†’ mode â†’ activeMode â†’ usage]
        T3[ä¼šè¯: sessionId â†’ ChatSessionå¯¹è±¡ â†’ session_idå­—ç¬¦ä¸²]
        T4[æ¶ˆæ¯: æ„å»ºå†å²messagesåˆ—è¡¨]
    end
    
    subgraph Storage["ğŸ’¾ æ•°æ®å­˜å‚¨"]
        S1[æ–‡ä»¶ä¿å­˜: media/agent_uploads/]
        S2[ChatMessage: åˆ›å»ºç”¨æˆ·å’ŒåŠ©æ‰‹æ¶ˆæ¯]
        S3[AgentTask: åˆ›å»ºä»»åŠ¡è®°å½•]
    end
    
    subgraph Process["âš¡ å¼‚æ­¥å¤„ç†"]
        P1[Celery: run_graph_task]
        P2[SSE: å®æ—¶æ¨é€è¿›åº¦]
        P3[æ›´æ–°: task_stepså’Œfinal_answer]
    end
    
    UI --> Transform
    Transform --> Storage
    Storage --> Process
    Process -.->|æ›´æ–°| Storage
```

## è¯¦ç»†å­—æ®µæ˜ å°„è¡¨ï¼ˆéè¡¨æ ¼å½¢å¼ï¼‰

### ğŸ”¹ å‰ç«¯åˆ°APIçš„æ˜ å°„
```
å‰ç«¯é¡µé¢ (page.tsx)          â†’    APIè·¯ç”± (route.ts)
â”œâ”€ message: string           â†’    message: string
â”œâ”€ activeMode: string        â†’    mode: string âš ï¸ å­—æ®µé‡å‘½å
â””â”€ uploadedFiles: Array      â†’    files: Array
   â”œâ”€ name: string           â†’    â”œâ”€ name: string
   â”œâ”€ type: string           â†’    â”œâ”€ type: string
   â”œâ”€ size: number           â†’    â”œâ”€ size: number
   â””â”€ data: base64           â†’    â””â”€ data: base64
                                  + sessionId: UUID (ä»URLè·å–)
```

### ğŸ”¹ APIåˆ°Djangoçš„æ˜ å°„
```
APIè·¯ç”± (route.ts)           â†’    Djangoè§†å›¾ (views.py)
â”œâ”€ message: string           â†’    message/content: string âš ï¸ å…¼å®¹ä¸¤ä¸ªå­—æ®µå
â”œâ”€ mode: string              â†’    activeMode: string âš ï¸ å­—æ®µæ¢å¤
â”œâ”€ files: Array              â†’    files: SimpleUploadedFile âš ï¸ Base64è§£ç 
â””â”€ sessionId: UUID           â†’    session_id: UUID
                                  + request.user: User (ä»è®¤è¯è·å–)
```

### ğŸ”¹ Djangoåˆ°ChatServiceçš„æ˜ å°„
```
Djangoè§†å›¾                    â†’    ChatService
â”œâ”€ session_id                â†’    session: ChatSession âš ï¸ æ•°æ®åº“æŸ¥è¯¢
â”œâ”€ message: string           â†’    message: string
â”œâ”€ æ–‡ä»¶ä¿å­˜ç»“æœ              â†’    files: List[Dict]
â”‚                                 â”œâ”€ path: æœåŠ¡å™¨è·¯å¾„
â”‚                                 â”œâ”€ name: æ–‡ä»¶å
â”‚                                 â”œâ”€ size: å¤§å°
â”‚                                 â””â”€ type: MIMEç±»å‹
â”œâ”€ activeMode: string        â†’    active_mode: string
â””â”€ request.user              â†’    user: User
```

### ğŸ”¹ ChatServiceåˆ°AgentServiceçš„æ˜ å°„
```
ChatService                  â†’    AgentService
â”œâ”€ session.id                â†’    session_id: str(UUID) âš ï¸ ç±»å‹è½¬æ¢
â”œâ”€ å†å²æ¶ˆæ¯æŸ¥è¯¢              â†’    messages: List[Dict]
â”‚                                 â”œâ”€ role: 'user'/'assistant'
â”‚                                 â””â”€ content: string
â”œâ”€ files                     â†’    files: List[Dict]
â”œâ”€ ç¡¬ç¼–ç                     â†’    graph_name: 'Super-Router Agent'
â””â”€ active_mode               â†’    usage: 'deep_research'/None âš ï¸ å€¼è½¬æ¢
   â””â”€ 'research'             â†’    'deep_research'
   â””â”€ å…¶ä»–                   â†’    None
```

## å…³é”®è½¬æ¢ç‚¹è¯´æ˜

### ğŸ”´ æ–‡ä»¶å¤„ç†é“¾è·¯
```
1. ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ (Fileå¯¹è±¡)
   â†“
2. å‰ç«¯è½¬Base64ç¼–ç 
   â†“
3. åç«¯è§£ç ä¸ºSimpleUploadedFile
   â†“
4. ä¿å­˜åˆ° media/agent_uploads/
   â†“
5. Agenté¢„å¤„ç†
   - docx â†’ markdown
   - excel â†’ ç»“æ„åŒ–æ•°æ®
   - pdf â†’ æ–‡æœ¬
   - å›¾ç‰‡ â†’ æè¿°æ–‡å­—
```

### ğŸ”µ æ¨¡å¼(Mode)è½¬æ¢é“¾
```
activeMode (å‰ç«¯)
   â†“ [é‡å‘½å]
mode (APIè·¯ç”±)
   â†“ [æ¢å¤åç§°]
activeMode (Django)
   â†“ [ä¼ é€’]
active_mode (ChatService)
   â†“ [å€¼æ˜ å°„]
usage (AgentService)
- 'research' â†’ 'deep_research'
- å…¶ä»– â†’ None
```

### ğŸŸ¢ ä¼šè¯IDæµè½¬
```
sessionId (URLå‚æ•°)
   â†“ [æ•°æ®åº“æŸ¥è¯¢]
ChatSessionå¯¹è±¡
   â†“ [æå–ID]
session.id (UUID)
   â†“ [è½¬å­—ç¬¦ä¸²]
session_id (string)
```

## æ•°æ®æ¨¡å‹å…³ç³»

```mermaid
erDiagram
    User ||--o{ ChatSession : has
    User ||--o{ AgentTask : creates
    ChatSession ||--o{ ChatMessage : contains
    Graph ||--o{ AgentTask : uses
    ChatMessage }o--|| AgentTask : references_via_task_id
    
    ChatSession {
        UUID id PK
        string title
        string ai_conversation_id
    }
    
    ChatMessage {
        int id PK
        string role
        text content
        string task_id FK
        json files_info
        json task_steps
    }
    
    AgentTask {
        UUID task_id PK
        string status
        UUID session_id
        json input_data
        json state_snapshot
    }
```