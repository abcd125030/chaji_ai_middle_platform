# -*- coding: utf-8 -*-
"""
build_task_guidance_for_prompt.py

æ„å»ºä»»åŠ¡æ‰§è¡ŒæŒ‡å¯¼æ–‡æœ¬ã€‚
ä¾› prompt_builder.py è°ƒç”¨ï¼Œç”¨äºç”Ÿæˆä»»åŠ¡æ‰§è¡ŒæŒ‡å¯¼è¯´æ˜ã€‚

è¿”å›å€¼ç¤ºä¾‹:
    è¿”å›æ ¼å¼åŒ–çš„ Markdown æ–‡æœ¬ï¼Œæ ¹æ®ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€æä¾›ç›¸åº”çš„æŒ‡å¯¼ï¼š
    
    é¦–æ¬¡æ‰§è¡Œæ—¶ï¼š
    '''
    ### ğŸ¯ ä»»åŠ¡è§„åˆ’æŒ‡å¯¼

    è¿™æ˜¯é¦–æ¬¡æ‰§è¡Œï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ªè¯¦ç»†çš„ä»»åŠ¡æ¸…å•æ¥æŒ‡å¯¼åç»­æ‰§è¡Œã€‚

    **é‡è¦æç¤ºï¼šTODOç®¡ç†å¿…é¡»é€šè¿‡ TodoGenerator å·¥å…·å®ç°**
    - å¿…é¡»ä½¿ç”¨ tool_name: "TodoGenerator" æ¥åˆ›å»ºå’Œç®¡ç†ä»»åŠ¡æ¸…å•

    ç¤ºä¾‹æ ¼å¼ï¼š
    ```json
    {
      "action": "CALL_TOOL",
      "thought": "åˆ†æç”¨æˆ·éœ€æ±‚ï¼Œéœ€è¦åˆ›å»ºè¯¦ç»†çš„ä»»åŠ¡æ¸…å•",
      "tool_name": "TodoGenerator",
      "tool_input": {
        "requirements": "ç”¨æˆ·çš„å…·ä½“éœ€æ±‚æè¿°",
        "context": "èƒŒæ™¯ä¿¡æ¯",
        "user_id": "ç”¨æˆ·ID"
      }
    }
    ```
    '''
    
    æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼š
    '''
    **ğŸ“‹ ä»»åŠ¡æŒ‡å¯¼**: å·²å®Œæˆ2ä¸ªä»»åŠ¡ï¼Œè¿˜å‰©3ä¸ªä»»åŠ¡å¾…å®Œæˆã€‚è¯·ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚
    '''
    
    å…¨éƒ¨å®Œæˆæ—¶ï¼š
    '''
    **âœ… ä»»åŠ¡æŒ‡å¯¼**: æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼è¯·ä½¿ç”¨FINISHåŠ¨ä½œç»“æŸä»»åŠ¡ã€‚
    '''
"""

from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from agentic.core.schemas import RuntimeState


def build_task_guidance_for_prompt(state: 'RuntimeState') -> str:
    """
    æ„å»ºä»»åŠ¡æ‰§è¡ŒæŒ‡å¯¼æ–‡æœ¬ã€‚
    
    å‚æ•°:
        state: è¿è¡Œæ—¶çŠ¶æ€å¯¹è±¡ï¼ŒåŒ…å«ä»»åŠ¡æ¸…å•å’Œæ‰§è¡Œå†å²ä¿¡æ¯
    
    è¿”å›:
        str: æ ¼å¼åŒ–çš„ä»»åŠ¡æŒ‡å¯¼æ–‡æœ¬ï¼Œä½¿ç”¨ Markdown æ ¼å¼ã€‚
        
        è¿”å›å€¼æ ¼å¼ï¼š
        - é¦–æ¬¡æ‰§è¡Œæ—¶è¿”å›è¯¦ç»†çš„ TodoGenerator ä½¿ç”¨æŒ‡å¯¼
        - ä»»åŠ¡æ¸…å•å‡†å¤‡å°±ç»ªæ—¶æç¤ºå¼€å§‹æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡
        - æ‰§è¡Œè¿‡ç¨‹ä¸­æ˜¾ç¤ºè¿›åº¦å’Œå‰©ä½™ä»»åŠ¡æ•°é‡
        - å…¨éƒ¨å®Œæˆæ—¶æç¤ºä½¿ç”¨ FINISH åŠ¨ä½œç»“æŸ
        
        ç‰¹æ®Šæƒ…å†µï¼š
        - å¦‚æœæ—¢æ²¡æœ‰ä»»åŠ¡æ¸…å•ä¹Ÿæ²¡æœ‰æ‰§è¡Œå†å²ï¼Œè¿”å›é¦–æ¬¡æ‰§è¡ŒæŒ‡å¯¼
        - å¦‚æœæœ‰ä»»åŠ¡æ¸…å•ä½†è¿˜æœªå¼€å§‹æ‰§è¡Œï¼Œæç¤ºå¼€å§‹æ‰§è¡Œ
        - å¦‚æœæ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆï¼Œæç¤ºç»“æŸä»»åŠ¡
    
    ç¤ºä¾‹:
        >>> from agentic.core.schemas import RuntimeState
        >>> state = RuntimeState()
        >>> # é¦–æ¬¡æ‰§è¡Œ
        >>> state.todo = []
        >>> state.full_action_data = {}
        >>> result = build_task_guidance_for_prompt(state)
        >>> print(result)
        ### ğŸ¯ ä»»åŠ¡è§„åˆ’æŒ‡å¯¼
        
        è¿™æ˜¯é¦–æ¬¡æ‰§è¡Œï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ªè¯¦ç»†çš„ä»»åŠ¡æ¸…å•æ¥æŒ‡å¯¼åç»­æ‰§è¡Œã€‚
        ...
        
        >>> # æ‰§è¡Œè¿‡ç¨‹ä¸­
        >>> state.todo = [
        ...     {'id': 1, 'task': 'æœç´¢èµ„æ–™', 'status': 'completed'},
        ...     {'id': 2, 'task': 'åˆ†ææ•°æ®', 'status': 'completed'},
        ...     {'id': 3, 'task': 'ç”ŸæˆæŠ¥å‘Š', 'status': 'pending'}
        ... ]
        >>> result = build_task_guidance_for_prompt(state)
        >>> print(result)
        **ğŸ“‹ ä»»åŠ¡æŒ‡å¯¼**: å·²å®Œæˆ2ä¸ªä»»åŠ¡ï¼Œè¿˜å‰©1ä¸ªä»»åŠ¡å¾…å®Œæˆã€‚è¯·ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚
        
        >>> # å…¨éƒ¨å®Œæˆ
        >>> state.todo = [
        ...     {'id': 1, 'task': 'æœç´¢èµ„æ–™', 'status': 'completed'},
        ...     {'id': 2, 'task': 'åˆ†ææ•°æ®', 'status': 'completed'},
        ...     {'id': 3, 'task': 'ç”ŸæˆæŠ¥å‘Š', 'status': 'completed'}
        ... ]
        >>> result = build_task_guidance_for_prompt(state)
        >>> print(result)
        **âœ… ä»»åŠ¡æŒ‡å¯¼**: æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼è¯·ä½¿ç”¨FINISHåŠ¨ä½œç»“æŸä»»åŠ¡ã€‚
    """
    if not state.todo and len(state.full_action_data) == 0:
        return """
### ğŸ¯ ä»»åŠ¡è§„åˆ’æŒ‡å¯¼

è¿™æ˜¯é¦–æ¬¡æ‰§è¡Œï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ªè¯¦ç»†çš„ä»»åŠ¡æ¸…å•æ¥æŒ‡å¯¼åç»­æ‰§è¡Œã€‚

**é‡è¦æç¤ºï¼šTODOç®¡ç†å¿…é¡»é€šè¿‡ TodoGenerator å·¥å…·å®ç°**
- å¿…é¡»ä½¿ç”¨ tool_name: "TodoGenerator" æ¥åˆ›å»ºå’Œç®¡ç†ä»»åŠ¡æ¸…å•

ç¤ºä¾‹æ ¼å¼ï¼š
```json
{
  "action": "CALL_TOOL",
  "thought": "åˆ†æç”¨æˆ·éœ€æ±‚ï¼Œéœ€è¦åˆ›å»ºè¯¦ç»†çš„ä»»åŠ¡æ¸…å•",
  "tool_name": "TodoGenerator",
  "tool_input": {
    "requirements": "ç”¨æˆ·çš„å…·ä½“éœ€æ±‚æè¿°",
    "context": "èƒŒæ™¯ä¿¡æ¯",
    "user_id": "ç”¨æˆ·ID"
  }
}
```"""
    
    if state.todo:
        completed_count = sum(1 for t in state.todo if t.get('status') == 'completed')
        total_count = len(state.todo)
        
        if completed_count == 0:
            return "\n**ğŸš€ ä»»åŠ¡æŒ‡å¯¼**: ä»»åŠ¡æ¸…å•å·²å‡†å¤‡å°±ç»ªï¼Œè¯·æŒ‰ç…§ä»»åŠ¡é¡ºåºæ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡ã€‚"
        elif completed_count < total_count:
            remaining = total_count - completed_count
            return f"\n**ğŸ“‹ ä»»åŠ¡æŒ‡å¯¼**: å·²å®Œæˆ{completed_count}ä¸ªä»»åŠ¡ï¼Œè¿˜å‰©{remaining}ä¸ªä»»åŠ¡å¾…å®Œæˆã€‚è¯·ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚"
        else:
            return "\n**âœ… ä»»åŠ¡æŒ‡å¯¼**: æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼è¯·ä½¿ç”¨FINISHåŠ¨ä½œç»“æŸä»»åŠ¡ã€‚"
    
    return ""