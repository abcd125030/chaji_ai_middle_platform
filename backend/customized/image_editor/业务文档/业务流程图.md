# Image Editor 业务流程图

**更新时间**: 2025-08-06
**状态**: 已根据最新代码实现更新

## 一、整体架构图

```mermaid
graph TB
    subgraph "客户端"
        Client[用户客户端]
    end
    
    subgraph "API层"
        API[Django REST API]
        Auth[JWT认证]
    end
    
    subgraph "业务层"
        Views[视图层]
        Serializers[序列化器]
    end
    
    subgraph "数据层"
        Models[数据模型]
        DB[(PostgreSQL)]
    end
    
    subgraph "异步处理"
        Celery[Celery队列]
        Tasks[异步任务]
    end
    
    subgraph "外部服务"
        Doubao[火山引擎AI API]
        Callback[回调服务]
    end
    
    Client --> API
    API --> Auth
    Auth --> Views
    Views --> Serializers
    Serializers --> Models
    Models --> DB
    Views --> Celery
    Celery --> Tasks
    Tasks --> Doubao
    Tasks --> Callback
    Tasks --> DB
```

## 二、单任务提交流程

```mermaid
sequenceDiagram
    participant C as 客户端
    participant A as API
    participant V as SubmitTaskView
    participant S as Serializer
    participant M as ImageEditTask
    participant Q as Celery队列
    participant T as 异步任务
    participant AI as 火山引擎AI
    participant CB as 回调服务
    
    C->>A: POST /submit {prompt, image, callback_url}
    A->>V: 认证通过
    V->>S: 验证参数
    S-->>V: 参数有效
    V->>M: 创建任务记录(status='processing')
    M-->>V: 返回task_id
    V->>Q: 提交异步任务
    V-->>C: 返回 {task_id, status, estimated_time}
    
    Note over Q,T: 异步处理流程
    Q->>T: 执行process_image_edit_task
    T->>T: 下载原图并验证
    T->>AI: 调用图片生成API
    AI-->>T: 返回生成的图片URL
    T->>T: 下载生成图片转base64
    T->>M: 更新任务状态(status='success')
    T->>CB: 如有callback_url则回调
```

## 三、任务查询流程

```mermaid
sequenceDiagram
    participant C as 客户端
    participant A as API
    participant V as QueryTaskResultView
    participant S as Serializer
    participant M as ImageEditTask
    
    C->>A: POST /result {task_id}
    A->>V: 认证通过
    V->>S: 验证task_id格式
    S-->>V: 格式有效
    V->>M: 查询任务记录
    M-->>V: 返回任务数据
    V->>V: 检查用户权限
    V->>V: 根据状态组装响应
    V-->>C: 返回任务状态和结果
```

## 四、数据模型关系

```mermaid
erDiagram
    User ||--o{ ImageEditTask : "创建"
    User ||--o{ BatchTask : "创建"
    
    ImageEditTask {
        uuid task_id PK
        string prompt
        string image_url
        string callback_url
        string status
        text result_image
        string error_code
        string error_message
        float processing_time
        datetime created_at
        datetime completed_at
    }
    
    BatchTask {
        uuid batch_id PK
        string callback_url
        int total_count
        int completed_count
        datetime created_at
    }
```

## 五、任务状态流转图

```mermaid
stateDiagram-v2
    [*] --> Processing: 创建任务
    Processing --> Success: 处理成功
    Processing --> Failed: 处理失败
    Processing --> Processing: 重试(最多3次)
    Success --> [*]: 完成
    Failed --> [*]: 结束
    
    state Processing {
        [*] --> 下载原图
        下载原图 --> 验证图片: 成功
        下载原图 --> 错误3002: 失败
        验证图片 --> 验证格式: 检查格式
        验证格式 --> 错误3003: JPG/PNG以外
        验证格式 --> 验证尺寸: 格式正确
        验证尺寸 --> 错误3004: 尺寸或宽高比不符
        验证尺寸 --> 验证大小: 尺寸正确
        验证大小 --> 错误3008: 超过10MB
        验证大小 --> 调用AI: 通过所有验证
        调用AI --> 下载结果: 成功
        调用AI --> 错误3001: 失败
        下载结果 --> 保存结果: 成功
        下载结果 --> 错误3001: 失败
        保存结果 --> 执行回调: 有callback_url
        保存结果 --> [*]: 无callback_url
        执行回调 --> [*]
    }
```

## 六、错误处理流程

```mermaid
graph TB
    Start[开始处理任务] --> TryProcess{尝试处理}
    
    TryProcess --> |成功| Success[更新状态为success]
    TryProcess --> |图片下载失败| Error3002[错误码3002: 图片下载失败]
    TryProcess --> |格式不支持| Error3003[错误码3003: 仅支持JPG/PNG]
    TryProcess --> |尺寸不符| Error3004[错误码3004: 尺寸或宽高比不符]
    TryProcess --> |文件过大| Error3008[错误码3008: 超过10MB]
    TryProcess --> |图片损坏| Error3017[错误码3017: 图片解码失败]
    TryProcess --> |AI生成失败| Error3001[错误码3001: 模型调用失败]
    TryProcess --> |其他错误| Error1006[错误码1006: 服务器内部错误]
    
    Error3002 --> UpdateFailed[更新状态为failed]
    Error3003 --> UpdateFailed
    Error3004 --> UpdateFailed
    Error3008 --> UpdateFailed
    Error3017 --> UpdateFailed
    Error3001 --> UpdateFailed
    Error1006 --> CheckRetry{检查重试次数}
    
    CheckRetry --> |小于3次| Retry[延迟重试]
    CheckRetry --> |达到3次| UpdateFailed
    
    Retry --> TryProcess
    UpdateFailed --> End[结束]
    Success --> Callback{有回调地址?}
    Callback --> |是| DoCallback[执行回调]
    Callback --> |否| End
    DoCallback --> End
```

## 七、API接口总览

| 接口路径 | 方法 | 功能 | 认证要求 |
|---------|------|------|---------|
| `/submit/` | POST | 提交单个任务 | 需要认证 |
| `/result/` | POST | 查询单个任务结果 | 需要认证 |
| `/batch_submit/` | POST | 批量提交任务 | 需要认证 |
| `/batch_result/` | POST | 批量查询结果 | 需要认证 |
| `/status/` | GET | API状态查询 | 无需认证 |

## 八、批量任务流程（已实现）

```mermaid
sequenceDiagram
    participant C as 客户端
    participant V as BatchSubmitTaskView
    participant B as BatchTask
    participant M as ImageEditTask
    participant Q as Celery队列
    
    C->>V: POST /batch_submit {tasks[], callback_url}
    V->>B: 创建批量任务记录
    loop 每个任务
        V->>M: 创建ImageEditTask记录
        V->>Q: 提交到Celery队列
    end
    V-->>C: 返回 {batch_id, tasks[], total_count}
```

## 九、已解决的问题

### 1. ✅ 批量功能已实现
- `BatchSubmitTaskView` 已实现批量任务创建逻辑
- `BatchTask` 模型已被使用，记录批量任务信息
- `BatchQueryTaskResultView` 已实现批量查询功能

### 2. ✅ 错误码体系已统一
- API层错误码已按文档规范使用：
  - 1002: 权限不足
  - 1003: 请求参数无效
  - 1004: 任务不存在
  - 1006: 服务器内部错误
- 业务层错误码已按文档规范使用：
  - 3001: 模型调用失败
  - 3002: 图片下载失败
  - 3003: 图片格式不支持
  - 3004: 图片尺寸不符合要求
  - 3008: 图片文件过大
  - 3017: 图片解码失败

### 3. ✅ 图片验证功能已实现
- 图片格式验证：仅支持 JPG、PNG（符合API文档）
- 图片尺寸验证：宽高必须大于 14 像素
- 宽高比验证：必须在 (1/3, 3) 范围内
- 文件大小验证：不超过 10MB
- 已添加 Pillow 依赖用于图片验证

### 4. 字段命名说明
- API参数：`image` - 符合API文档规范
- 数据库字段：`image_url` - 内部存储使用
- 返回结果：`result_image` - 区分原图和结果图
- 命名符合各层职责，无需修改

## 十、当前系统特性

1. **完整的错误处理**：根据不同的失败原因返回对应的错误码
2. **图片验证**：在下载后立即验证，避免无效图片进入AI处理
3. **批量处理**：支持批量提交和查询，提高处理效率
4. **异步处理**：使用 Celery 实现异步任务处理
5. **回调机制**：支持任务完成后的回调通知
6. **权限控制**：用户只能查询自己的任务