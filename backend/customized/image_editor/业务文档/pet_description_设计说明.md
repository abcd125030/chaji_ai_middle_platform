# Pet Description 设计说明

## 设计目标

`pet_description` 字段的核心目标是生成一个**极其精确和详细的宠物描述**，使得文生图模型能够根据这个描述重建出几乎一模一样的宠物，包括其姿态动作和微小而特定的细节特征。

## 实现方案

### 1. 数据模型
- 在 `ImageEditTask` 模型中添加了 `pet_description` TextField 字段
- 数据库迁移文件：`0008_add_pet_description.py`

### 2. 预检API优化

#### 2.1 结构化输出
- 添加 `response_format: {"type": "json_object"}` 参数，强制API返回结构化JSON
- 避免了复杂的文本解析，提高了可靠性

#### 2.2 详细描述要求
预检提示词要求包含以下六个方面的详细描述：

1. **品种与体型**
   - 准确的品种名称
   - 体型大小
   - 身材比例

2. **毛发特征**
   - 毛发长度（短毛/中长毛/长毛）
   - 毛发质地（直毛/卷毛/波浪毛、粗糙/柔软/丝滑）
   - 毛发密度和蓬松程度

3. **颜色与花纹**
   - 主色调和次要色调的精确描述
   - 特殊花纹或斑点的位置、形状、大小
   - 渐变色或混色区域的描述

4. **面部特征**
   - 眼睛：颜色、大小、形状、神态
   - 鼻子：颜色、湿润度
   - 嘴巴：是否张开、舌头位置
   - 耳朵：形状、位置、朝向

5. **姿态与动作**
   - 身体姿势（站立/坐姿/卧姿/奔跑/跳跃等）
   - 头部朝向和角度
   - 四肢位置和动作
   - 尾巴位置和状态

6. **特殊细节**
   - 独特的标记或特征
   - 配饰的颜色、材质、样式
   - 表情和情绪状态

### 3. 数据流程

#### 3.1 生成流程
```
图片输入 → 预检API（生成详细描述） → 保存到本地对象 → 图像生成 → 成功后保存到数据库
```

#### 3.2 存储策略
- **延迟写入**：预检通过时只更新本地对象，不立即写数据库
- **批量保存**：任务完全成功后，一次性写入所有字段（包括 `pet_description`）
- **缓存同步**：成功时同步更新Redis缓存，包含 `pet_description`

#### 3.3 查询返回
- API响应中包含 `pet_description` 字段（如果存在）
- 从缓存和数据库查询都支持该字段

## 示例描述

### 良好的描述示例
```
一只成年雄性金毛寻回犬，体型中大，身材匀称健壮。拥有中长度的金棕色直毛，
毛发浓密蓬松，在阳光下呈现出温暖的蜂蜜色光泽。面部特征鲜明：深棕色的大眼睛
流露出温和友善的神情，黑色湿润的鼻子，粉红色的舌头微微外露。耳朵呈三角形
自然下垂，紧贴头部两侧。此刻正以坐姿端正地面向镜头，前腿笔直支撑，后腿
自然弯曲，尾巴自然下垂触地，尾尖的毛发略长呈羽毛状。颈部佩戴一条深蓝色的
尼龙项圈，项圈上有银色的金属扣环。整体表情放松愉悦，嘴角微微上扬呈现微笑状。
光线从左前方照射，在地面投下柔和的阴影。
```

## 未来应用场景

1. **文生图重建**：使用描述生成相似的宠物图像
2. **图像检索**：基于文本描述搜索相似宠物
3. **数据标注**：自动为宠物图像生成详细标签
4. **个性化推荐**：基于宠物特征推荐相关内容

## 配置说明

### 自定义提示词
如需自定义预检提示词，可以：
1. 复制 `prompts_config.example.py` 为 `prompts_config.py`
2. 修改 `IMAGE_DETECTION_PROMPT` 变量
3. 系统会自动使用自定义的提示词

### 默认配置
如果没有 `prompts_config.py` 文件，系统会使用内置的详细描述提示词。

## 注意事项

1. **描述长度**：建议150-300字，过短可能缺少细节，过长可能影响性能
2. **准确性**：描述必须准确，错误的描述会影响后续应用
3. **隐私保护**：不包含可能识别宠物主人身份的信息
4. **性能考虑**：详细描述会增加API响应时间，需要权衡精度与性能