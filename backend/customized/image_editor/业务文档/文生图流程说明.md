# 文生图流程说明

## 概述

系统已从原有的 **Seededit 3.0 I2I（图生图）** 模式切换为 **Seedream 3.0 T2I（文生图）** 模式。新流程通过精确的文本描述来生成风格化的宠物图像，而不依赖于输入图像的编辑。

## 处理流程

### 第一步：宠物检测与描述生成

1. **接收输入图片**
   - 用户上传宠物图片
   - 进行基础验证（格式、尺寸等）

2. **预检与描述生成**
   - 调用检测模型（`doubao-1.5-vision-pro-250328`）
   - 检查图片合规性
   - 生成详细的宠物描述（150-300字）
   - 描述包含7个方面：
     - 品种与体型
     - 毛发特征
     - 颜色与花纹
     - 面部特征
     - 姿态与动作
     - 特殊细节
     - 环境关系

3. **返回结构化数据**
   ```json
   {
     "object_is_only_animal": true,
     "reason_for_false": null,
     "pet_description": "详细的宠物描述..."
   }
   ```

### 第二步：文生图生成

1. **构建组合提示词**
   ```
   组合提示词 = 宠物描述 + 风格化要求
   ```
   - 宠物描述：来自第一步的 `pet_description`
   - 风格化要求：从配置中获取 `style_prompt`
   - 默认风格："油画刮刀风格，刮刀笔触适中，色彩饱满偏暖，姿态鲜活自然，纯白色背景#ffffff"

2. **调用文生图API**
   - 模型：`doubao-seedream-3-0-t2i-250415`
   - 参数：
     - prompt: 组合提示词
     - size: 1024x1024（可配置）
     - guidance_scale: 7.5（可配置）
     - seed: 随机或固定（可配置）
     - watermark: 可配置

3. **跳过一致性检查**
   - 文生图不需要与原图比较
   - 自动设置一致性为通过

### 第三步：背景移除（可选）

- 对生成的图片进行背景移除
- 使用火山引擎CV服务
- 保留主体宠物，移除背景

### 第四步：保存结果

- 保存生成的图片
- 更新数据库记录
- 执行回调通知

## API差异对比

| 特性 | Seededit (I2I) | Seedream (T2I) |
|-----|---------------|---------------|
| 模型 | doubao-seededit-3-0-i2i-250628 | doubao-seedream-3-0-t2i-250415 |
| 输入 | 需要图片URL + 提示词 | 仅需要提示词 |
| 用途 | 编辑现有图片风格 | 从文本生成新图片 |
| 一致性检查 | 需要 | 不需要 |
| 默认尺寸 | adaptive | 1024x1024 |
| 默认guidance_scale | 10.0 | 7.5 |

## 配置管理

### 数据库配置字段

1. **检测相关**
   - `detection_model`: 宠物检测模型
   - `detection_prompt`: 自定义检测提示词

2. **文生图相关**
   - `t2i_model`: 文生图模型
   - `t2i_size`: 输出尺寸
   - `t2i_guidance_scale`: 引导系数
   - `style_prompt`: 风格化提示词

3. **通用配置**
   - `use_random_seed`: 是否随机seed
   - `add_watermark`: 是否添加水印
   - `response_format`: 响应格式（url/b64_json）

### 配置优先级

1. Django Admin 配置（最高优先级）
2. prompts_config.py 文件
3. 代码默认值

## 优势

1. **更精确的控制**：通过详细的文本描述精确控制生成内容
2. **风格一致性**：所有生成的图片风格统一
3. **无需原图限制**：不受原图质量和角度的限制
4. **灵活性更高**：可以生成原图中不存在的姿态和场景

## 注意事项

1. **描述质量**：宠物描述的质量直接影响生成效果
2. **提示词长度**：组合提示词可能很长（200-400字），注意API限制
3. **生成时间**：文生图可能比图生图需要更长时间
4. **风格统一**：确保风格化提示词与业务需求匹配

## 迁移说明

### 数据库迁移

执行以下迁移文件：
- `0008_add_pet_description.py` - 添加宠物描述字段
- `0009_add_detection_prompt.py` - 添加检测提示词配置
- `0010_add_t2i_config.py` - 添加文生图配置字段

### 代码变更

1. **doubao_seededit_3_0_i2_seed.py**
   - 新增 `generate_image_from_text()` 方法
   - 保留原有 `generate_image()` 方法（已弃用）

2. **tasks.py**
   - 修改图像生成流程，使用文生图API
   - 跳过一致性检查步骤
   - 组合宠物描述和风格化提示词

3. **config_manager.py**
   - 新增文生图相关配置获取方法

4. **admin.py**
   - 重组配置界面，突出文生图参数

## 监控指标

建议监控以下指标：
- 宠物描述生成成功率
- 文生图API调用成功率
- 平均生成时间
- 用户满意度（如有反馈机制）