# 迭代说明：从图生图到文生图的流程重构

**版本**：2025-08-14  
**迭代范围**：图像编辑器核心流程  
**影响级别**：重大变更

## 一、迭代背景

### 业务需求
- 需要更精确地控制生成图像的内容和风格
- 希望生成的图像风格更加统一
- 不再依赖原图质量，提高生成成功率

### 技术决策
- 从 **Seededit 3.0 I2I（图生图）** 切换到 **Seedream 3.0 T2I（文生图）**
- 通过详细的文本描述来生成图像，而非编辑原图

## 二、核心变更内容

### 2.1 预检流程升级

#### 结构化输出
- **变更前**：返回可能包含markdown或其他格式的文本
- **变更后**：强制返回JSON格式，使用 `response_format: {"type": "json_object"}`

#### 描述质量提升
- **变更前**：简短的宠物描述（10-30字）
- **变更后**：极其详细的宠物描述（150-300字）

#### 描述维度
新的描述包含7个维度：
1. 品种与体型
2. 毛发特征（长度、质地、密度）
3. 颜色与花纹（主次色调、特殊标记）
4. 面部特征（眼睛、鼻子、嘴巴、耳朵）
5. 姿态与动作（身体姿势、四肢、尾巴）
6. 特殊细节（独特标记、配饰、表情）
7. 环境关系（位置、光照、阴影）

### 2.2 图像生成方式变更

#### API调用变更
```python
# 变更前：图生图
generator.generate_image(
    image_url=task.image_url,  # 需要原图
    prompt=prompt
)

# 变更后：文生图
generator.generate_image_from_text(
    prompt=combined_prompt,  # 仅需要文本
    model='doubao-seedream-3-0-t2i-250415',
    size='1024x1024'
)
```

#### 提示词组合策略
```python
combined_prompt = f"{pet_description}，{style_prompt}"
# pet_description: 预检生成的详细描述
# style_prompt: 配置的风格化要求
```

### 2.3 一致性检查调整

- **变更前**：需要检查生成图与原图的一致性
- **变更后**：自动跳过，设置默认值
  - `consistency_check = True`
  - `consistency_score = 100.0`
  - `consistency_reason = null`

## 三、数据模型变更

### 3.1 新增数据库字段

#### ImageEditTask 模型
| 字段 | 类型 | 说明 |
|-----|------|------|
| pet_description | TextField | 存储预检生成的宠物详细描述 |

#### ImageEditorConfig 模型
| 字段 | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| detection_prompt | TextField | null | 自定义检测提示词 |
| style_prompt | TextField | "油画刮刀风格..." | 风格化要求 |
| t2i_model | CharField | doubao-seedream-3-0-t2i-250415 | 文生图模型 |
| t2i_size | CharField | 1024x1024 | 输出尺寸 |
| t2i_guidance_scale | FloatField | 7.5 | 引导系数 |

### 3.2 数据库迁移

需要执行以下迁移：
1. `0008_add_pet_description.py`
2. `0009_add_detection_prompt.py`
3. `0010_add_t2i_config.py`

## 四、代码变更清单

### 4.1 修改的文件

1. **doubao_seededit_3_0_i2_seed.py**
   - 新增 `generate_image_from_text()` 方法
   - 更新 `check_object_is_only_animal()` 提示词
   - 添加结构化输出支持

2. **tasks.py**
   - 修改图像生成流程调用
   - 组合宠物描述和风格提示词
   - 跳过一致性检查
   - 保存 pet_description

3. **config_models.py**
   - 添加5个新配置字段
   - 支持文生图参数配置

4. **config_manager.py**
   - 新增5个配置获取方法
   - 支持文生图配置管理

5. **models.py**
   - 添加 pet_description 字段

6. **admin.py**
   - 重组配置界面
   - 分离图生图和文生图参数
   - 优化显示逻辑

7. **views.py**
   - 更新缓存处理逻辑
   - 支持 pet_description 字段

### 4.2 新增的文件

1. **migrations/0008_add_pet_description.py**
2. **migrations/0009_add_detection_prompt.py**
3. **migrations/0010_add_t2i_config.py**
4. **业务文档/pet_description_设计说明.md**
5. **业务文档/文生图流程说明.md**
6. **业务文档/迭代说明_从图生图到文生图.md**（本文档）

## 五、配置说明

### 5.1 配置优先级

1. Django Admin 配置（最高优先级）
2. prompts_config.py 文件配置
3. 代码中的默认值

### 5.2 关键配置项

通过 Django Admin 可配置：
- **检测提示词**：控制宠物描述的详细程度
- **风格提示词**：定义输出图像的艺术风格
- **文生图模型**：选择使用的AI模型
- **输出尺寸**：控制生成图像的分辨率
- **引导系数**：平衡创造性与准确性

## 六、兼容性说明

### 6.1 向后兼容

✅ **完全兼容的部分**：
- API接口格式不变
- 生成图片URL字段名不变
- 背景移除流程不变
- 回调机制不变
- 缓存结构兼容

### 6.2 需要注意的变更

⚠️ **行为变化**：
- 生成的图像不再基于原图编辑
- 一致性检查始终为通过
- 生成时间可能略有增加

## 七、部署步骤

### 7.1 代码部署

1. 更新代码到最新版本
2. 确保所有Python依赖已安装

### 7.2 数据库迁移

```bash
python manage.py migrate image_editor
```

### 7.3 配置调整

1. 登录 Django Admin
2. 进入"图片编辑器配置"
3. 调整以下参数：
   - 风格提示词（根据业务需求）
   - 文生图模型（确认为 doubao-seedream-3-0-t2i-250415）
   - 输出尺寸（推荐 1024x1024）

### 7.4 验证

1. 提交测试任务
2. 检查日志中的"文生图模式"标记
3. 验证生成结果的风格一致性

## 八、监控要点

### 8.1 关键指标

- **预检通过率**：监控宠物检测的成功率
- **描述生成质量**：检查 pet_description 字段的长度和内容
- **文生图成功率**：监控 API 调用成功率
- **平均处理时间**：对比原流程的时间变化

### 8.2 日志关键词

- "使用组合提示词" - 表示进入文生图流程
- "文生图模式，跳过一致性检测" - 确认跳过了一致性检查
- "火山引擎文生图成功" - API调用成功

## 九、回滚方案

如需回滚到原图生图模式：

1. **代码层面**：
   - 恢复 tasks.py 中的 `generate_image()` 调用
   - 恢复一致性检查逻辑

2. **数据库层面**：
   - 新增字段可保留，不影响原流程

3. **配置层面**：
   - 将 generation_model 改回 doubao-seededit-3-0-i2i-250628

## 十、已知限制

1. **提示词长度**：组合提示词可能达到 300-400 字，需注意 API 限制
2. **生成时间**：文生图可能比图生图耗时略长
3. **风格固定**：所有输出采用统一风格，缺少多样性

## 十一、后续优化建议

1. **描述模板化**：建立不同宠物类型的描述模板
2. **风格多样化**：支持多种预设风格供选择
3. **质量评分**：建立生成图像的自动质量评分机制
4. **缓存优化**：缓存常见宠物描述，减少重复计算

---

**文档维护**：本文档应随系统迭代持续更新  
**联系方式**：如有问题请联系开发团队