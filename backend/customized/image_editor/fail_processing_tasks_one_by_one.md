# 用途概述

- 逐条把状态为 `processing` 的图片编辑任务更新为 `failed`，用于清理卡住的任务并避免连接池带来的问题（`fail_processing_tasks_one_by_one.py:3–5`）
- 使用 Django 直连数据库并定期手动关闭连接，提升在异常或高负载下的稳健性（`...:24, 80–83`）
- 执行前进行交互式确认并打印预计耗时（按每条约 `50ms` 估算）（`...:41`）

## 关键特性

- 分批连接管理：每处理 100 条任务主动 `connection.close()`，避免长连接占用（`...:80–83`）
- 进度与统计：每 10 条或最后一条输出进度，结束后打印成功/失败数量及状态分布（`...:67–70, 85–98`）
- 细粒度容错：单条更新失败不会中断整体流程，记录并继续（`...:74–78`）
- 信号/钩子友好：逐条 `save()` 触发模型信号与钩子，适合需要副作用的场景（`...:62`；对比批量 `update` 不触发）

## 处理流程

- 初始化环境与 Django（`...:17–20`），导入模型与工具（`...:22–24`）
- 查询所有 `processing` 任务的 `task_id` 列表并统计数量（`...:31–33`）
- 人工确认：收到 `yes` 后才执行（`...:41–45`）
- 循环处理每个任务：
  - 取任务对象并设置 `status='failed'`、`error_code='SYSTEM_TIMEOUT'`、`error_message`、`error_details`、`completed_at=timezone.now()`，再 `save()`（`...:56–62`）
  - 打印阶段进度、每条间隔 `50ms`（`...:67–73`）
  - 每 100 条关闭一次连接（`...:80–83`）
- 汇总与状态统计：打印成功/失败数量与当前各状态计数（`...:85–98`）

## 适用场景

- 连接池或代理出现不稳定/泄漏，批量更新容易失败
- 需要触发模型层面的信号、审计或副作用
- 任务量较大但希望用“稳妥、可观测”的方式逐步清理

## 与批量脚本的差异

- 执行方式：本脚本逐条 `save()`，另一脚本一次 `update()` 批量修改（`fail_processing_tasks.py:92–99`）
- 稳健性：本脚本更适合绕过连接池问题并保持副作用；批量脚本更快但不触发模型信号
- 观测性：本脚本提供细粒度进度与错误统计；批量脚本只输出汇总

## 运行方式（Windows）

- 直连执行：
  ```bat
  python d:\my_github\chaji_ai_middle_platform\backend\customized\image_editor\fail_processing_tasks_one_by_one.py
  ```

## 安全提醒

- 不可逆操作：会把所有 `processing` 任务改为 `failed`，务必在确认前检查数量与状态
- 建议先在测试环境验证，再于维护窗口执行，并准备数据库备份
- 幂等性：已失败的任务不再匹配 `processing` 条件，重复执行不会重复处理

如需在“逐条失败”前增加筛选条件（如按用户、时间范围、任务类型），告诉我你的筛选规则，我可以为该脚本加上安全过滤和额外的确认输出。加上安全过滤和额外的确认输出。