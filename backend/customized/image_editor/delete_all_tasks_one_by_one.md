# 用途概述

- 逐条删除所有图片编辑任务与批量任务，包含数据库记录与生成的图片文件，不可逆
- 直连数据库并定期手动断开连接，规避连接池不稳定问题
- 清理与任务相关的缓存键（`task:*`），并输出进度、耗时与结果统计

## 关键流程

- 环境初始化：设置 Django 配置并初始化（`delete_all_tasks_one_by_one.py:17–22`）
- 查询与统计：获取所有 `ImageEditTask.task_id` 与 `BatchTask.batch_id`，统计数量（`...:31–37`）
- 双重确认与耗时估算：需要 `yes` 与 `DELETE ALL` 两次确认，并按每条约 `50ms` 估算总耗时（`...:45–60, 46–47`）
- 删除图片文件目录：删除 `MEDIA_ROOT/image_editor` 下的所有文件与目录（`...:65–77`）
- 逐条删除数据库记录：任务 `task.delete()` 与批量任务 `batch.delete()`，每条间隔 `50ms`，每 100 条关闭一次连接（`...:82–107, 109–134`）
- 结果与剩余统计：输出成功/失败计数与当前剩余任务数（`...:136–151`）
- 缓存清理：若安装 `django-redis`，逐条删除 `task:*` 键，每键间隔 `10ms`（`...:153–165`）

## 适用场景

- 需要触发逐条删除的模型信号或钩子以保证副作用执行
- 连接池或代理不稳定，批量删除容易失败或占用连接资源
- 希望更强的过程观测性（进度、耗时、失败统计）

## 与批量删除脚本的差异

- 本脚本：逐条 `delete()`，触发模型信号；有进度与连接节流；更稳健但耗时更久
- 批量脚本（`delete_all_tasks.py`）：`QuerySet.delete()` 一次性删除，更快但不逐条触发信号，过程观测性较弱

## 运行方式（Windows）

- 直连执行：
  ```bat
  python d:\my_github\chaji_ai_middle_platform\backend\customized\image_editor\delete_all_tasks_one_by_one.py
  ```

## 安全提醒

- 不可逆操作，且会同时删除数据库记录与磁盘文件，务必确认两次提示
- 建议在维护窗口或开发/测试环境执行，并确保正确配置 `MEDIA_ROOT`
- 大量数据删除需较长时间，执行期间会间歇关闭数据库连接以降低占用