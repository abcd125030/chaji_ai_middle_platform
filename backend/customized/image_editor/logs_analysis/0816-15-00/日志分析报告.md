# 高并发图片处理任务日志分析报告

## 业务说明
1. 前端发任务请求
2. 任务进redis队列
3. celery执行任务（队列重试3次）
	- 宠物检测API，调用 vision 模型，输出预期是：a. 宠物检测，b. 当为是时，宠物的描述词；（重试3次）
	- 文生图API，调用 seedream 模型，使用输出的描述词和风格词；（重试3次）
	- 背景抠图API，调用图像分割小模型，使用文生图的url链接（重试3次）
	- 图片拉取和处理（缩图）
	- 完毕后立即回调任务
4. 回写数据库

## 数据库统计结果（2025-08-16 13:29-16:22）

### 核心指标
| 指标 | 数值 | 说明 |
|-----|------|------|
| **总任务数** | 49,263 | 约3小时内处理的任务总量 |
| **任务成功数** | 40,446 | 成功完成图片处理的任务 |
| **任务失败数** | 8,817 | 处理失败的任务 |
| **任务成功率** | 82.10% | 整体任务完成率较高 |
| **回调成功数** | 40,246 | 成功通知前端的任务 |
| **未回调数** | 9,017 | 未能回调前端的任务 |
| **回调率** | 81.70% | 有18.30%的任务未能通知前端 |
| **回调成功率** | 100% | 已回调的任务全部成功（0失败） |

### 关键发现
1. **任务失败率17.90%** - 8,817个任务在处理阶段失败
2. **未回调率18.30%** - 9,017个任务未能通知前端结果
3. **回调失败数为0** - 数据库中没有记录回调失败的情况，说明回调要么成功要么未执行
4. **失败任务≈未回调任务** - 8,817失败任务与9,017未回调任务数量接近，表明大部分失败任务都未能回调


## 分析概要
- **分析时间**: 2025-08-16
- **日志时间范围**: 2025-08-16 13:38 - 16:24
- **分析目录**: `/Users/chagee/Repos/X/backend/customized/image_editor/logs_analysis/0816-15-00/`
- **日志文件**: 10个worker日志 + 1个beat日志
- **任务链路**: 前端 → 后端(Celery) → 火山引擎API(文生图/背景移除) → 回调前端

## 1. 数据对比分析

### 1.1 数据库记录 vs 日志错误对比
| 维度 | 数据库记录 | 日志分析 | 差异说明 |
|-----|-----------|----------|---------|
| **总任务数** | 49,263 | - | 数据库完整记录 |
| **任务失败** | 8,817 (17.90%) | 15,517次文生图失败 | 日志包含重试记录 |
| **回调问题** | 9,017未回调 (18.30%) | 13,110次回调失败 | 日志记录了失败尝试 |
| **成功率** | 82.10% | 约65.7%(文生图) | 数据库统计最终结果 |

### 1.2 主要错误分布（基于日志）
| 错误类型 | 次数 | 占比 | 影响环节 |
|---------|------|------|---------|
| 文生图失败 | 15,517 | 36.8% | 后端→火山引擎文生图API |
| 回调失败 | 13,110 | 31.1% | 后端→前端回调 |
| 背景移除超时 | 12,333 | 29.3% | 后端→火山引擎视觉API |
| 宠物检测服务异常 | 848 | 2.0% | 后端→火山引擎视觉API |
| 图片内容检测异常 | 218 | 0.5% | 后端→火山引擎视觉API |
| 一致性检测失败 | 56 | 0.1% | 后端内部处理 |
| 图片内容不符合要求 | 2 | <0.1% | 内容审核 |
| **总计** | **42,084** | 100% | - |

### 1.2 典型错误示例

#### 背景移除超时示例
```
[2025-08-16 13:41:25,091: ERROR/MainProcess] 背景移除API请求超时: 
HTTPSConnectionPool(host='visual.volcengineapi.com', port=443): Read timed out. (read timeout=20)
[2025-08-16 13:41:25,091: ERROR/MainProcess] Error details - Request URL: 
https://visual.volcengineapi.com/?Action=CVProcess&Version=2022-08-31
[2025-08-16 13:41:25,091: ERROR/MainProcess] 背景移除失败 - 任务ID: bb569536-00e5-4e6f-ae42-0a80846db033, 
尝试1/2, 错误: 背景移除超时
```

#### 文生图失败示例
```
[2025-08-16 13:47:24,937: ERROR/MainProcess] T2I API请求失败: 
HTTPSConnectionPool(host='ark.cn-beijing.volces.com', port=443): 
Max retries exceeded with url: /api/v3/images/generations 
(Caused by ConnectTimeoutError: Connection to ark.cn-beijing.volces.com timed out. (connect timeout=60))
[2025-08-16 13:47:24,937: ERROR/MainProcess] AI模型生成失败 - 任务ID: 156c5954-b7c0-472a-b679-6497cdf30bc0
```

#### 回调失败示例
```
[2025-08-16 13:41:46,075: INFO/MainProcess] 发送回调请求到: https://perf-game-center.chagee.com/game-cute-pet-biz/api/callback/aiImg
[2025-08-16 13:41:46,075: INFO/MainProcess] 回调数据: {'params': {'code': 0, 'data': {'task_id': '661a51f4-4048-4c67-9e51-b82c3ce82da6', 
'status': 'success', 'data': {...}, 'message': 'success', 'timestamp': 1755322906074}, ...}
[2025-08-16 13:41:46,082: ERROR/MainProcess] 发送回调请求失败: 
HTTPSConnectionPool(host='perf-game-center.chagee.com', port=443): Read timed out. (read timeout=30)
```
说明：系统尝试向前端服务器发送成功结果，但因前端响应超时（30秒）导致回调失败


### 1.3 链路故障分析

#### 文生图环节（后端→火山引擎文生图API）
- **总调用次数**: 约45,253次
- **失败次数**: 15,517次（失败率34.3%）
- **失败任务数**: 7,787个（部分任务多次重试）
- **失败原因分解**:
  - **外部API性能问题（8,153次，52.5%）**:
    - Read timed out（读取超时）: 3,059次（19.7%）
    - API处理异常: 3,818次（24.6%）
    - Max retries exceeded（重试超限）: 638次（4.1%）
    - Connection timed out（连接超时）: 638次（4.1%）
  - **内容审核拦截（121次，0.8%）**:
    - OutputImageSensitiveContentDetected: 120次（敏感内容检测）
    - Pre Img Risk Not Pass: 1次（图片风险检测）
  - **其他网络错误（7,243次，46.7%）**:
    - 连接异常（connection timeout expired）: 151次（1.0%）
    - 未分类网络错误: 7,092次（45.7%）

**结论**: 
1. 外部API性能问题占52.5%，是文生图失败的主要原因
2. 火山引擎API在高并发下存在性能瓶颈
3. 46.7%的其他网络错误需要进一步排查

#### 背景移除环节（后端→火山引擎视觉API）
- **失败次数**: 12,333次
- **API地址**: visual.volcengineapi.com
- **超时设置**: read timeout=20秒, total timeout=60秒
- **特征**: 集中在高并发时段，API响应时间超过20秒

**结论**: 背景移除API在处理复杂图片时响应时间过长。

#### 回调环节（后端→前端）
- **失败次数**: 13,110次
- **目标地址**: perf-game-center.chagee.com
- **超时设置**: 30秒
- **失败类型**: 主要为连接超时和连接中断

**结论**: 前端服务器在高并发下处理能力不足。

## 2. 时间分布特征

### 2.1 错误高峰时段
- 13:41-13:47: 第一波高峰，大量超时错误
- 13:47-13:55: 文生图失败集中爆发
- 14:30-15:00: 持续的背景移除超时
- 15:45-16:00: 回调失败高峰

### 2.2 级联效应
1. 文生图API超时 → 任务堆积 → 重试增加负载
2. 背景移除超时 → 任务延迟 → 回调队列拥堵
3. 回调失败 → 前端重新请求 → 系统负载进一步增加

## 3. 性能瓶颈分析

### 3.1 外部API瓶颈
| API服务 | 域名 | 问题 | 影响 |
|---------|------|------|------|
| 文生图API | ark.cn-beijing.volces.com | 响应慢、连接不稳定 | 34.3%任务失败 |
| 背景移除API | visual.volcengineapi.com | 处理超时 | 12,333次失败 |

### 3.2 重试机制问题
- **任务重试机制**: 失败后立即重试加重系统负担
- **缺乏退避策略**: 连续重试导致API压力倍增
- **无熔断保护**: 持续向已过载的服务发送请求

## 4. 关键指标

### 4.1 成功率统计
- 文生图成功率: 65.7%
- 背景移除成功率: 约75%（估算）
- 回调成功率: 约85%（估算）
- 端到端成功率: 约42%

### 4.2 性能指标
- 平均处理时间: 20-40秒（正常情况）
- 超时任务平均耗时: >60秒
- 重试次数: 平均2-3次/失败任务

## 5. 结论

本次高并发场景分析揭示了三个层面的问题：

### 5.1 主要问题分布
1. **外部API性能问题**: 火山引擎API（文生图34.3%失败率，其中52.5%由于API性能问题；背景移除12,333次超时）是最主要瓶颈
2. **未分类网络异常（46.7%）**: 大量网络相关错误需要进一步诊断
3. **前端服务器瓶颈（13,110次）**: 回调失败显示前端服务器无法及时处理高并发请求
4. **内容审核（0.8%）**: 少量请求因内容审核被拦截

### 5.2 核心发现
- **系统整体成功率82.10%**，表现尚可，但存在优化空间
- **火山引擎API是主要瓶颈**，文生图环荂34.3%的失败率严重影响整体性能
- **存在大量未分类网络错误**，46.7%的错误需要更详细的监控和分类
- **级联效应明显**：任务失败→重试→负载增加→更多失败的恶性循环