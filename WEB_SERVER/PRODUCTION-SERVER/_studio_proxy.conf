#PROXY-START/_studio

location ^~ /_studio
{
    proxy_pass http://127.0.0.1:3323;
    proxy_set_header Host 127.0.0.1;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_http_version 1.1;
    # proxy_hide_header Upgrade;

    add_header X-Cache $upstream_cache_status;

    # =========================================================
    # 以下是关键修改，确保 Nginx 和浏览器都不缓存此路径内容
    # =========================================================

    # 1. 禁用 Nginx 对此 location 的 proxy_cache
    proxy_cache off;         # 明确关闭本 location 的代理缓存
    proxy_no_cache 1;        # 确保不写入缓存
    proxy_cache_bypass 1;    # 确保不读取缓存

    # 2. 忽略后端应用发出的缓存控制头，完全由 Nginx 控制
    proxy_ignore_headers Cache-Control Expires Set-Cookie;

    # 3. 强制浏览器不缓存任何内容
    expires off; # 禁用 Nginx 默认的 expires 指令
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";

    # =========================================================
    # 移除或注释掉原有的 Set Nginx Cache 部分，因为它会被上面的规则覆盖和冲突
    # =========================================================
    # Set Nginx Cache # 原有注释行
    # set $static_fileidWNlE7P 0; # 原有变量定义
    # if ( $uri ~* "\.(gif|png|jpg|css|js|woff|woff2)$" ) # 原有静态文件判断
    # {
    # 	set $static_fileidWNlE7P 1;
    # 	expires 1m; # 此行导致静态文件缓存1分钟
    # }
    # if ( $static_fileidWNlE7P = 0 ) # 原有非静态文件判断
    # {
    # add_header Cache-Control no-cache; # 此行对非静态文件有效，但上面的 no-store 更强
    # }
}

#PROXY-END/_studio