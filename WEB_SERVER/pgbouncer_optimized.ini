;;;
;;; PgBouncer 优化配置文件
;;; 针对170 QPS，20秒任务处理时间优化
;;;

[databases]
; 主数据库连接
X = host=localhost port=5432 dbname=X

; 如需添加其他数据库，使用以下格式：
; dbname = host=localhost port=5432 dbname=realdbname user=dbuser password=dbpass

[users]
; 用户特定配置（可选）
; user1 = pool_mode=transaction max_user_connections=100

[pgbouncer]

;;;
;;; 管理设置
;;;
logfile = /var/log/postgresql/pgbouncer.log
pidfile = /var/run/postgresql/pgbouncer.pid

;;;
;;; 监听设置
;;;
listen_addr = localhost
listen_port = 6432
unix_socket_dir = /var/run/postgresql

;;;
;;; 认证设置
;;;
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt
admin_users = postgres, pgbouncer
stats_users = postgres, pgbouncer, root

;;;
;;; 连接池核心配置（关键优化）
;;;

; 池模式：transaction模式最适合高并发短连接
pool_mode = transaction

; 客户端连接限制
; 支持10000个gevent协程连接
max_client_conn = 10000

; 默认连接池大小（重要优化）
; 从800降到200，因为transaction模式下连接复用率高
default_pool_size = 200

; 最小连接池大小
; 保持50个连接始终可用，减少冷启动延迟
min_pool_size = 50

; 预留连接池
; 用于处理突发流量
reserve_pool_size = 100

; 预留池超时
; 2秒后启用预留池
reserve_pool_timeout = 2

; 数据库最大连接数
; 与PostgreSQL max_connections(1500)匹配，留300给直连
max_db_connections = 1200

; 用户最大连接数
max_user_connections = 1200

;;;
;;; 连接健康检查
;;;
server_check_query = select 1
server_check_delay = 30

;;;
;;; 超时配置（针对20秒任务优化）
;;;

; 服务器连接生命周期
server_lifetime = 3600

; 空闲连接超时（优化）
; 60秒后关闭空闲连接，释放资源
server_idle_timeout = 60

; 查询等待超时（优化）
; 5秒内必须获得连接，否则失败
query_wait_timeout = 5

; 查询超时
; 0表示不限制（让PostgreSQL的statement_timeout控制）
query_timeout = 0

; 客户端空闲超时
; 30秒无活动断开连接
client_idle_timeout = 30

; 客户端登录超时
client_login_timeout = 60

;;;
;;; 日志设置
;;;
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
stats_period = 60

;;;
;;; 底层调优
;;;

; 数据包缓冲区
pkt_buf = 4096

; 监听队列大小
listen_backlog = 128

; TCP保活
tcp_keepalive = 1

; DNS缓存
dns_max_ttl = 15
dns_nxdomain_ttl = 15

;;;
;;; 性能优化总结
;;;
; 1. default_pool_size从800降到200 - 减少空闲连接
; 2. min_pool_size=50 - 保持热连接池
; 3. server_idle_timeout=60 - 快速释放空闲连接
; 4. query_wait_timeout=5 - 快速失败机制
; 5. reserve_pool_size=100 - 应对突发流量